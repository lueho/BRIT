{% extends "base.html" %}
{% load static %}

{% block title %}
BRIT | Materials Module Diagram
{% endblock title %}

{% block custom_style %}
<style>
    .diagram-container {
        background: #fff;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        overflow-x: auto;
    }

    .diagram-container .node rect,
    .diagram-container .node polygon,
    .diagram-container .node circle {
        cursor: pointer;
    }

    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 1.5rem;
        font-size: 0.85rem;
    }

    .legend-line {
        width: 2rem;
        height: 0;
        display: inline-block;
        margin-right: 0.4rem;
        vertical-align: middle;
    }

    .legend-line--fk {
        border-top: 2px solid #666;
    }

    .legend-line--m2m {
        border-top: 2px dashed #666;
    }

    .legend-swatch {
        width: 1rem;
        height: 1rem;
        border-radius: 3px;
        display: inline-block;
        margin-right: 0.4rem;
        vertical-align: middle;
    }

    .legend-swatch--clickable {
        background: #dbeafe;
        border: 2px solid #1e40af;
    }

    .legend-swatch--internal {
        background: #f3f4f6;
        border: 2px solid #9ca3af;
    }
</style>
{% endblock custom_style %}

{% block content %}
<div class="mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
            <h2 class="mb-1">Materials Module &mdash; Model Diagram</h2>
            <p class="text-muted mb-0">Click on any highlighted model to open its list view.</p>
        </div>
        <a href="{% url 'materials-explorer' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-1"></i> Back to Explorer
        </a>
    </div>
</div>

<div class="mb-3">
    <span class="legend-item"><span class="legend-swatch legend-swatch--clickable"></span> Browsable model (click to
        open)</span>
    <span class="legend-item"><span class="legend-swatch legend-swatch--internal"></span> Internal model</span>
    <span class="legend-item"><span class="legend-line legend-line--fk"></span> Foreign key</span>
    <span class="legend-item"><span class="legend-line legend-line--m2m"></span> Many-to-many</span>
</div>

<div class="diagram-container">
    <pre class="mermaid">
%%{init: {'securityLevel': 'loose', 'theme': 'default', 'flowchart': {'curve': 'basis', 'nodeSpacing': 30, 'rankSpacing': 60}}}%%
flowchart TD

    subgraph classification["Materials &amp; Classification"]
        MaterialCategory["MaterialCategory"]
        Material["Material"]
        MaterialComponent["MaterialComponent"]
        MaterialComponentGroup["MaterialComponentGroup"]
    end

    subgraph props["Properties"]
        MaterialPropertyGroup["MaterialPropertyGroup"]
        MaterialProperty["MaterialProperty"]
        MaterialPropertyValue["MaterialPropertyValue"]
    end

    subgraph analysis["Samples &amp; Analysis"]
        AnalyticalMethod["AnalyticalMethod"]
        SampleSeries["SampleSeries"]
        Sample["Sample"]
    end

    subgraph comp["Compositions &amp; Measurements"]
        Composition["Composition"]
        ComponentMeasurement["ComponentMeasurement"]
        WeightShare["WeightShare"]
    end

    %% ---- FK relationships (solid) ----
    SampleSeries -->|"material"| Material
    Sample -->|"material"| Material
    Sample -->|"series"| SampleSeries
    MaterialProperty -->|"group"| MaterialPropertyGroup
    MaterialProperty -->|"default_basis_component"| MaterialComponent
    MaterialPropertyValue -->|"property"| MaterialProperty
    MaterialPropertyValue -->|"analytical_method"| AnalyticalMethod
    Composition -->|"sample"| Sample
    Composition -->|"group"| MaterialComponentGroup
    Composition -->|"fractions_of"| MaterialComponent
    ComponentMeasurement -->|"sample"| Sample
    ComponentMeasurement -->|"group"| MaterialComponentGroup
    ComponentMeasurement -->|"component"| MaterialComponent
    ComponentMeasurement -->|"analytical_method"| AnalyticalMethod
    WeightShare -->|"composition"| Composition
    WeightShare -->|"component"| MaterialComponent

    %% ---- M2M relationships (dashed) ----
    Material -.-|"categories"| MaterialCategory
    Sample -.-|"properties"| MaterialPropertyValue
    SampleSeries -.-|"temporal_distributions"| TD_ext["TemporalDistribution &#40;ext&#41;"]
    AnalyticalMethod -.-|"sources"| Src_ext["Source &#40;ext&#41;"]

    %% ---- Styling ----
    classDef clickable fill:#dbeafe,stroke:#1e40af,stroke-width:2px,color:#1e3a5f
    classDef internal fill:#f3f4f6,stroke:#9ca3af,stroke-width:1px,color:#4b5563
    classDef external fill:#fef9c3,stroke:#ca8a04,stroke-width:1px,color:#713f12,font-style:italic

    class Material,MaterialCategory,MaterialComponent,MaterialComponentGroup clickable
    class MaterialProperty clickable
    class AnalyticalMethod,SampleSeries,Sample clickable
    class MaterialPropertyGroup,Composition,ComponentMeasurement,WeightShare,MaterialPropertyValue internal
    class TD_ext,Src_ext external

    %% ---- Click handlers ----
    click Material href "{% url 'material-list' %}" _self
    click MaterialCategory href "{% url 'materialcategory-list' %}" _self
    click MaterialComponent href "{% url 'materialcomponent-list' %}" _self
    click MaterialComponentGroup href "{% url 'materialcomponentgroup-list' %}" _self
    click MaterialProperty href "{% url 'materialproperty-list' %}" _self
    click AnalyticalMethod href "{% url 'analyticalmethod-list' %}" _self
    click SampleSeries href "{% url 'sampleseries-list' %}" _self
    click Sample href "{% url 'sample-list' %}" _self
        </pre>
</div>
{% endblock content %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        mermaid.initialize({
            startOnLoad: true,
            securityLevel: 'loose',
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
            },
        });
    });
</script>
{% endblock javascript %}