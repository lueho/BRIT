{% extends "base.html" %}
{% load static %}
{% load moderation_tags %}
{% load custom_tags %}

{% block title %}
    BRIT | Sample Detail
{% endblock title %}

{% block content %}
    {% object_policy object as policy %}
    <div class="row">
        <div class="col col-12 col-md-6 col-lg-3 mt-4">
            <div class="card shadow h-100">
                <div class="card-header bg-body-tertiary border-bottom-0 py-3">
                    <h5 class="mb-0">Sample Details</h5>
                </div>
                {% if object.image %}
                    <div class="card-img-top">
                        <img class="w-100 m-0" src="{{ object.image.url }}" alt="Image of sample">
                    </div>
                {% endif %}
                <div class="card-body">
                    <p class="card-text">
                        <strong>Name:</strong>
                        <br>
                        {{ object.name }}
                    </p>
                    <p class="card-text">
                        <b>Material:</b>
                        <br>
                        <a href="{% url 'material-detail-modal' object.material.pk %}"
                           class="modal-link">{{ object.material.name }}</a>
                    </p>

                    {% if object.series %}
                        <p class="card-text">
                            <b>Series:</b>
                            <br>
                            <a href="{% url 'sampleseries-detail-modal' object.series.pk %}"
                               class="modal-link">{{ object.series.name }}</a>
                        </p>
                    {% endif %}

                    {% if data.timestep %}
                        <p class="card-text">
                            <b>Timestep:</b>
                            <br>
                            {{ data.timestep }}
                        </p>
                    {% endif %}

                    {% if data.datetime %}
                        <p class="card-text">
                            <b>Date/Time:</b>
                            <br>
                            {{ data.datetime }}
                        </p>
                    {% endif %}

                    {% if object.location %}
                        <p class="card-text">
                            <b>Location:</b>
                            <br>
                            {{ object.location }}
                        </p>
                    {% endif %}

                    {% if data.description %}
                        <p class="card-text">
                            <b>Description:</b>
                            <br>
                            {{ object.description }}
                        </p>
                    {% endif %}

                    {% if object.analysis_date %}
                        <p class="card-text">
                            <b>Analysis Date:</b>
                            <br>
                            {{ object.analysis_date|date:"Y-m-d" }}
                        </p>
                    {% endif %}

                    {% if object.analysis_laboratory %}
                        <p class="card-text">
                            <b>Laboratory:</b>
                            <br>
                            {{ object.analysis_laboratory }}
                        </p>
                    {% endif %}

                    {% if object.lab_accreditation %}
                        <p class="card-text">
                            <b>Lab Accreditation:</b>
                            <br>
                            {{ object.lab_accreditation }}
                        </p>
                    {% endif %}

                    {% if object.analysis_objective %}
                        <p class="card-text">
                            <b>Analysis Objective:</b>
                            <br>
                            {{ object.analysis_objective }}
                        </p>
                    {% endif %}

                    {% with sample_sources=object.sources.all %}
                        {% if sample_sources %}
                            <p class="card-text">
                                <b>Sources:</b>
                                <br>
                                {% for source in sample_sources %}
                                    <a href="{% url 'source-detail-modal' source.pk %}" class="modal-link">
                                        {{ source.abbreviation }}
                                        {% if not forloop.last %},{% endif %}
                                    </a>
                                {% endfor %}
                            </p>
                        {% endif %}
                    {% endwith %}
                </div>
                <div class="card-footer d-flex">
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle"
                                type="button"
                                id="navigateDropdown"
                                data-bs-toggle="dropdown"
                                aria-expanded="false">Navigate</button>
                        <div class="dropdown-menu" aria-labelledby="navigateDropdown">
                            <a class="dropdown-item" href="{% url 'sample-list' %}">
                                <i class="fas fa-fw fa-list"></i> Public Samples
                            </a>
                            <a class="dropdown-item" href="{% url 'sample-list-owned' %}">
                                <i class="fas fa-fw fa-list"></i> My Samples
                            </a>
                            <a class="dropdown-item" href="{% url 'materials-dashboard' %}">
                                <i class="fas fa-fw fa-table-cells-large"></i> Explorer
                            </a>
                        </div>
                    </div>
                    {% if policy.can_edit or policy.can_delete or policy.can_duplicate or policy.is_owner or policy.is_staff or policy.is_moderator %}
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle ms-3"
                                    type="button"
                                    id="editDropdown"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">Options</button>
                            <div class="dropdown-menu" aria-labelledby="editDropdown">
                                {% if policy.can_edit %}
                                    <a class="dropdown-item" href="{% url 'sample-update' object.id %}">
                                        <i class="fas fa-pen-to-square"></i> Edit
                                    </a>
                                {% endif %}
                                {% if policy.is_owner and policy.is_in_review %}
                                    <a class="dropdown-item"
                                       href="{% url 'object_management:review_item_detail' content_type_id=object|get_content_type_id object_id=object.id %}?next={{ object.get_absolute_url|urlencode }}">
                                        <i class="fas fa-fw fa-clipboard-check"></i> Review view
                                    </a>
                                {% endif %}
                                {% if policy.can_duplicate %}
                                    <a class="dropdown-item" href="{% url 'sample-duplicate' object.id %}">
                                        <i class="fas fa-fw fa-copy"></i> Duplicate
                                    </a>
                                {% endif %}
                                {% if policy.can_delete %}
                                    <a class="dropdown-item modal-link"
                                       href="{% url 'sample-delete-modal' object.pk %}">
                                        <i class="fas fa-fw fa-trash"></i> Delete
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    {% if policy.is_owner and policy.is_in_review %}
                        <a class="btn btn-outline-secondary ms-3"
                           href="{% url 'object_management:review_item_detail' content_type_id=object|get_content_type_id object_id=object.id %}?next={{ object.get_absolute_url|urlencode }}">
                            <i class="fas fa-clipboard-check"></i> Review view
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col col-12 col-md-6 col-lg-3 mt-4">
            <div class="card shadow h-100">
                <div class="card-header bg-body-tertiary border-bottom-0 py-3">
                    <h5 class="mb-0">Properties</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Property</th>
                                <th>Value</th>
                                <th>Method</th>
                                <th>Sources</th>
                                {% if policy.can_add_property %}<th class="remove-property collapse multi-collapse">Remove</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for property in object.properties.all %}
                                <tr>
                                    <td>
                                        <a href="{% url 'materialproperty-detail-modal' property.property.pk %}"
                                           class="modal-link">{{ property.property.name }}</a>
                                    </td>
                                    <td>
                                        {{ property.average|trim_decimal:6 }}
                                        ± {{ property.standard_deviation|trim_decimal:6 }} {{ property.property.unit }}
                                    </td>
                                    <td>
                                        {% if property.analytical_method %}
                                            <a href="{% url 'analyticalmethod-detail-modal' property.analytical_method.pk %}"
                                               class="modal-link">{{ property.analytical_method.name }}</a>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% for source in property.sources.all %}
                                            <a href="{% url 'source-detail-modal' source.pk %}" class="modal-link">
                                                {{ source.abbreviation }}
                                                {% if not forloop.last %},{% endif %}
                                            </a>
                                        {% empty %}
                                            -
                                        {% endfor %}
                                    </td>
                                    {% if policy.can_add_property %}
                                        <td class="remove-property collapse multi-collapse">
                                            <a href="{% url 'materialpropertyvalue-delete-modal' property.id %}?next={{ request.path }}"
                                               class="modal-link">
                                                <i class="fas fa-fw fa-trash"></i>
                                            </a>
                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    {% if policy.can_add_property %}
                        <a href="{% url 'sample-add-property' object.id %}">
                            <i class="fas fa-fw fa-plus"></i> Add property
                        </a>
                        <a class="ms-3"
                           href="javascript:void(0);"
                           data-bs-toggle="collapse"
                           data-bs-target=".remove-property"
                           aria-expanded="false"
                           aria-controls="remove-property">
                            <i class="fas fa-fw fa-minus"></i> Remove properties
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col col-12 col-md-6 col-lg-6 mt-4">
            <div class="card shadow h-100">
                <div class="card-header bg-body-tertiary border-bottom-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Component Measurements</h5>
                    {% regroup component_measurements by group as measurements_by_group %}
                    {% if measurements_by_group %}
                        <div class="d-flex gap-2">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button"
                                        class="btn btn-outline-secondary btn-sm"
                                        onclick="expandAllGroups()">
                                    <i class="fas fa-expand-alt"></i> Expand
                                </button>
                                <button type="button"
                                        class="btn btn-outline-secondary btn-sm"
                                        onclick="collapseAllGroups()">
                                    <i class="fas fa-compress-alt"></i> Collapse
                                </button>
                            </div>
                            <button type="button"
                                    class="btn btn-outline-primary btn-sm"
                                    id="exportBtn"
                                    onclick="exportMeasurements()">
                                <i class="fas fa-file-excel"></i> Export
                            </button>
                        </div>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if measurements_by_group %}
                        <div class="accordion accordion-flush" id="measurementsAccordion">
                            {% for group in measurements_by_group %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading-{{ forloop.counter }}">
                                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %} py-2"
                                                type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#collapse-{{ forloop.counter }}"
                                                aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                                                aria-controls="collapse-{{ forloop.counter }}">
                                            <strong>{{ group.grouper.name }}</strong>
                                            <span class="badge bg-secondary ms-2">{{ group.list|length }}</span>
                                        </button>
                                    </h2>
                                    <div id="collapse-{{ forloop.counter }}"
                                         class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                                         aria-labelledby="heading-{{ forloop.counter }}"
                                         data-bs-parent="#measurementsAccordion">
                                        <div class="accordion-body p-0">
                                            <table class="table table-sm table-striped mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th class="ps-3">Component</th>
                                                        <th>Abbr.</th>
                                                        <th>Basis</th>
                                                        <th>Value</th>
                                                        <th class="text-center">n</th>
                                                        <th>Method</th>
                                                        <th>Sources</th>
                                                        <th class="pe-3">Comments</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for measurement in group.list %}
                                                        <tr>
                                                            <td class="ps-3">{{ measurement.component.name }}</td>
                                                            <td>{{ measurement.component.abbreviation|default:"-" }}</td>
                                                            <td>{{ measurement.basis_component.name|default:"-" }}</td>
                                                            <td class="text-nowrap">
                                                                <strong>{{ measurement.average|trim_decimal:4 }}</strong>
                                                                {% if measurement.standard_deviation %}
                                                                    <small class="text-muted">± {{ measurement.standard_deviation|trim_decimal:2 }}</small>
                                                                {% endif %}
                                                                <small>{{ measurement.unit }}</small>
                                                            </td>
                                                            <td class="text-center">{{ measurement.sample_size|default:"-" }}</td>
                                                            <td>
                                                                {% if measurement.analytical_method %}
                                                                    <a href="{% url 'analyticalmethod-detail-modal' measurement.analytical_method.pk %}"
                                                                       class="modal-link text-truncate d-inline-block"
                                                                       style="max-width: 120px"
                                                                       title="{{ measurement.analytical_method.name }}">
                                                                        {{ measurement.analytical_method.name }}
                                                                    </a>
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% for source in measurement.sources.all %}
                                                                    <a href="{% url 'source-detail-modal' source.pk %}"
                                                                       class="modal-link badge bg-light text-dark text-decoration-none"
                                                                       title="{{ source.title|default:source.abbreviation }}">
                                                                        {{ source.abbreviation|default:"Source" }}
                                                                    </a>
                                                                {% empty %}
                                                                    <span class="text-muted">-</span>
                                                                {% endfor %}
                                                            </td>
                                                            <td class="pe-3">
                                                                {% if measurement.comment %}
                                                                    {{ measurement.comment }}
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="p-3 text-muted">No component measurements.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        {% for composition in data.compositions %}
            <div class="col col-12 col-md-6 col-lg-3 mt-4">
                <div class="card shadow mt-3 h-100 tab-card">
                    <div class="card-header tab-card-header bg-body-tertiary border-bottom-0 py-3">
                        <h5 class="mb-0">
                            <a href="{% url 'materialcomponentgroup-detail-modal' composition.group %}"
                               class="modal-link text-decoration-none text-body">{{ composition.group_name }}</a>
                        </h5>
                        <ul class="nav nav-tabs card-header-tabs"
                            id="composition-tabs-{{ composition.id }}"
                            role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active"
                                   id="composition-table-tab-{{ composition.id }}"
                                   data-bs-toggle="tab"
                                   href="#composition-table-{{ composition.id }}-tab"
                                   role="tab"
                                   aria-controls="composition-table-{{ composition.id }}-tab"
                                   aria-selected="true">Table</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link"
                                   id="composition-chart-tab-{{ composition.id }}"
                                   data-bs-toggle="tab"
                                   href="#composition-chart-{{ composition.id }}-tab"
                                   role="tab"
                                   aria-controls="composition-chart-{{ composition.id }}-tab"
                                   aria-selected="false">Chart</a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body tab-content"
                         id="composition-tabs-{{ group_settings.id }}-content">
                        <div class="tab-pane fade show active"
                             id="composition-table-{{ composition.id }}-tab"
                             role="tabpanel"
                             aria-labelledby="composition-table-tab-{{ composition.id }}">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Share</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for share in composition.shares %}
                                        <tr>
                                            <td>
                                                <a href="{% url 'materialcomponent-detail-modal' share.component %}"
                                                   class="modal-link">{{ share.component_name }}</a>
                                            </td>
                                            {# <td>{{ share.average }} ± {{ share.standard_deviation }} %</td>#}
                                            <td>{{ share.as_percentage }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot></tfoot>
                            </table>

                        </div>
                        <div class="tab-pane fade p-0"
                             id="composition-chart-{{ composition.id }}-tab"
                             role="tabpanel"
                             aria-labelledby="composition-chart-tab-{{ composition.id }}">
                            <div id="composition-chart-{{ composition.id }}"></div>
                        </div>
                        <b>Shares of:</b> {{ composition.fractions_of_name }}
                    </div>
                    <div class="card-footer d-flex">
                        {% if policy.can_manage_samples %}
                            <a id="move-group-{{ composition.id }}-left"
                               href="{% url 'composition-order-down' composition.id %}?next={{ request.path }}"
                               class="me-3 nowrap">
                                <i class="fas fa-fw fa-arrow-left"></i>
                            </a>
                            <a id="edit-group-{{ composition.id }}"
                               href="{% url 'composition-update' composition.id %}?next={{ request.path }}"
                               class="me-3 nowrap">
                                <i class="fas fa-fw fa-pen-to-square"></i> Edit
                            </a>
                            <a id="remove-group-{{ composition.id }}"
                               href="{% url 'composition-delete-modal' composition.id %}?next={{ request.path }}"
                               class="me-3 nowrap modal-link">
                                <i class="fas fa-fw fa-trash"></i> Delete
                            </a>
                            <a id="move-group-{{ composition.id }}-right"
                               href="{% url 'composition-order-up' composition.id %}?next={{ request.path }}"
                               class="ms-auto nowrap">
                                <i class="fas fa-fw fa-arrow-right"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    {% if policy.can_manage_samples %}
        <div id="add-component-group">
            <div class="row">
                <div class="col mt-4">
                    <div class="card border-left-primary border">
                        <div class="card-header bg-body-tertiary border-bottom-0 py-3"></div>
                        <div class="card-body">
                            <a href="{% url 'sample-add-composition' object.id %}?next={{ request.path }}">
                                <i class="fas fa-fw fa-plus"></i> Add composition
                            </a>
                        </div>
                        <div class="card-footer"></div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

{% endblock content %}

{% block javascript %}
    {{ block.super }}
    {{ charts|json_script:"charts" }}

    <script>

        const charts = JSON.parse(document.getElementById("charts").textContent);

        Object.keys(charts).forEach(key => {
            let container = document.getElementById(key);
            if (container) {
                let canvas = document.createElement('canvas');
                canvas.setAttribute('id', key + '-canvas');
                container.appendChild(canvas);
                new Chart(canvas.getContext('2d'), charts[key]);
            } else {
                console.error('Chart container not found:', key);
            }
        });

        function expandAllGroups() {
            const accordion = document.getElementById('measurementsAccordion');
            if (!accordion) return;
            accordion.querySelectorAll('.accordion-collapse').forEach(collapse => {
                const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapse, {toggle: false});
                bsCollapse.show();
            });
        }

        function collapseAllGroups() {
            const accordion = document.getElementById('measurementsAccordion');
            if (!accordion) return;
            accordion.querySelectorAll('.accordion-collapse').forEach(collapse => {
                const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapse, {toggle: false});
                bsCollapse.hide();
            });
        }

        function exportMeasurements() {
            const exportBtn = document.getElementById('exportBtn');
            const originalContent = exportBtn.innerHTML;

            // Disable button and show loading state
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';

            // Start export task
            fetch('{% url "sample-export" object.pk %}')
                .then(response => response.json())
                .then(data => {
                    if (data.task_id) {
                        pollExportProgress(data.task_id, exportBtn, originalContent);
                    } else {
                        throw new Error('No task ID returned');
                    }
                })
                .catch(error => {
                    console.error('Export error:', error);
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalContent;
                    alert('Failed to start export: ' + error.message);
                });
        }

        function pollExportProgress(taskId, exportBtn, originalContent) {
            const progressUrl = '{% url "file-export-progress" "TASK_ID" %}'.replace('TASK_ID', taskId);

            fetch(progressUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.state === 'PROGRESS') {
                        const percent = data.details?.percent || 0;
                        const status = data.details?.status || 'Processing...';
                        exportBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${percent}%`;
                        setTimeout(() => pollExportProgress(taskId, exportBtn, originalContent), 500);
                    } else if (data.state === 'SUCCESS') {
                        // data.details contains the download URL
                        exportBtn.disabled = false;
                        exportBtn.innerHTML = '<i class="fas fa-check"></i> Done!';

                        // Trigger download
                        if (data.details && data.details.url) {
                            window.location.href = data.details.url;
                        }

                        // Reset button after a delay
                        setTimeout(() => {
                            exportBtn.innerHTML = originalContent;
                        }, 2000);
                    } else if (data.state === 'FAILURE') {
                        exportBtn.disabled = false;
                        exportBtn.innerHTML = originalContent;
                        alert('Export failed: ' + (data.details?.error || 'Unknown error'));
                    } else if (data.state === 'PENDING') {
                        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Queued...';
                        setTimeout(() => pollExportProgress(taskId, exportBtn, originalContent), 1000);
                    } else {
                        // Unknown state, keep polling
                        setTimeout(() => pollExportProgress(taskId, exportBtn, originalContent), 1000);
                    }
                })
                .catch(error => {
                    console.error('Progress check error:', error);
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalContent;
                    alert('Failed to check export progress: ' + error.message);
                });
        }

    </script>

{% endblock javascript %}
