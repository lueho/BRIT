{% load static %}
<div class="source-list-widget-container card mb-3"
     data-field-name="{{ widget.name }}">
    {# Hidden select for form submission - only contains selected values #}
    <select name="{{ widget.name }}"
            id="{{ widget.attrs.id }}"
            multiple
            style="display: none"
            {% include "django/forms/widgets/attrs.html" %}>
        {% for option in widget.optgroups %}
            {% for opt in option.1 %}<option value="{{ opt.value }}" selected>{{ opt.label }}</option>{% endfor %}
        {% endfor %}
    </select>

    <div class="card-header bg-light">
        <h6 class="mb-0">
            <i class="fas fa-book me-1"></i> Bibliographic References
        </h6>
    </div>

    <div class="card-body py-2 border-bottom bg-light">
        <p class="text-muted small mb-0">
            Research papers, books, reports, and other documented sources with full metadata (authors, year, DOI, etc.).
            Use the autocomplete to search by title or abbreviation.
        </p>
    </div>

    <div class="card-body">
        {# Section 1: Search and add existing sources #}
        <div class="source-add-section mb-3">
            <label class="form-label small fw-semibold mb-1">Search existing sources</label>
            <input type="text"
                   id="{{ widget.attrs.id }}_add"
                   class="form-control source-tomselect-add"
                   placeholder="Search by title, author or abbreviation..."
                   value=""
                   data-autocomplete-url="{% url widget.autocomplete_url %}"
                   data-quick-create-url="{% url 'source-quick-create' %}"
                   data-author-autocomplete-url="{% url 'author-autocomplete' %}"
                   data-author-quick-create-url="{% url 'author-quick-create' %}"
                   data-label-field="{{ widget.label_field }}"
                   data-target-select="{{ widget.attrs.id }}">
        </div>

        {# Section 2: Create a new source #}
        <div class="source-create-section border rounded p-3 bg-light mb-3"
             id="{{ widget.attrs.id }}_create_section">
            <p class="small fw-semibold mb-2">Create new source</p>
            <div class="mb-2">
                <label class="form-label small mb-1" for="{{ widget.attrs.id }}_new_title">
                    Title <span class="text-danger">*</span>
                </label>
                <input type="text"
                       id="{{ widget.attrs.id }}_new_title"
                       class="form-control form-control-sm source-new-title"
                       placeholder="Publication title">
            </div>
            <div class="mb-2">
                <label class="form-label small mb-1" for="{{ widget.attrs.id }}_authors">Authors</label>
                <input type="text"
                       id="{{ widget.attrs.id }}_authors"
                       class="form-control form-control-sm source-author-tomselect-add"
                       placeholder="Search or type name, then press Enter to add"
                       data-author-autocomplete-url="{% url 'author-autocomplete' %}"
                       data-author-quick-create-url="{% url 'author-quick-create' %}">
                <p class="text-muted small mt-1 mb-0">
                    For organisations or single names, type the full name and press Enter. For persons, use "Last, First" format.
                </p>
            </div>
            <div class="mb-2">
                <label class="form-label small mb-1" for="{{ widget.attrs.id }}_year">Year</label>
                <input type="number"
                       id="{{ widget.attrs.id }}_year"
                       class="form-control form-control-sm source-year-input"
                       min="0"
                       step="1"
                       placeholder="e.g. 2024">
            </div>
            <button type="button"
                    class="btn btn-sm btn-primary source-create-btn"
                    data-target-select="{{ widget.attrs.id }}">Add source</button>
            <p class="text-danger small mt-2 mb-0 d-none"
               id="{{ widget.attrs.id }}_feedback"></p>
        </div>

        {# List of selected sources #}
        <div class="source-selected-list">
            <label class="form-label fw-semibold">Selected:</label>
            <ul class="list-group"
                id="{{ widget.attrs.id }}_list"
                data-detail-url-pattern="{% url 'source-detail-modal' 0 %}">
                {% for option in widget.optgroups %}
                    {% for opt in option.1 %}
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            data-value="{{ opt.value }}">
                            <div class="source-title">
                                <a href="{% url 'source-detail-modal' opt.value %}"
                                   class="modal-link text-decoration-none">{{ opt.label }}</a>
                            </div>
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger source-remove-btn"
                                    data-value="{{ opt.value }}"
                                    aria-label="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </li>
                    {% endfor %}
                {% endfor %}
            </ul>
            <p class="text-muted small mt-2 mb-0"
               id="{{ widget.attrs.id }}_empty"
               style="{% if widget.value %}display: none;
                      {% endif %}">No sources selected yet. Use the search above to add sources.</p>
        </div>
    </div>
</div>
