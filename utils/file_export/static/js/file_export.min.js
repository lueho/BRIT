"use strict";const POLLING_INTERVAL_MS=500;function export_to_file(t,e){"READY"===t.dataset.exportStatus&&(t.dataset.exportStatus="PENDING",prepare_export(e).then((t=>start_export(t,e))).then((t=>monitor_export_progress(t,e))).catch((t=>{resetExportLink(e)})))}async function prepare_export(t){const e=getLinkElements(t);if(!e)throw new Error(`Export elements for format "${t}" not found.`);e.link.classList.add("disabled");const n=document.getElementById("export_"+t),o=n.dataset.exportUrl,r=window.location.search;let s=o;r&&(s+=(o.includes("?")?"&":"?")+r.slice(1));const a=new URL(s,window.location.origin);a.searchParams.set("format",t);const i=n.dataset.listType;return i&&a.searchParams.set("list_type",i),a.pathname+"?"+a.searchParams.toString()}async function start_export(t,e){try{const n=await fetch(t);if(!n.ok)throw new Error(`Network response was not ok: ${n.status}`);const o=await n.json();if(!o.task_id)throw new Error("Task ID missing in export response.");return document.getElementById("export_"+e).dataset.exportProgressUrl.replace("0",o.task_id)}catch(t){throw t}}async function monitor_export_progress(t,e,n=0){try{const o=await fetch(t);if(!o.ok)throw new Error(`Monitoring response was not ok: ${o.status}`);const r=await o.json();"PENDING"===r.state?(updateProcessingLink(e,n+1),setTimeout((()=>monitor_export_progress(t,e,n+1)),500)):"SUCCESS"===r.state?cleanup_export(!0,r,e):"FAILURE"===r.state&&cleanup_export(!1,r,e)}catch(t){resetExportLink(e)}}function cleanup_export(t,e,n){!0===t&&e.details?formatDownloadLink(e.details,n):resetExportLink(n)}function initExportHandlers(){const t=document.querySelectorAll(".export-format-item");t&&t.forEach((t=>{t.addEventListener("click",(function(){export_to_file(this,this.dataset.format)}))}))}function getLinkElements(t){const e=document.getElementById("export_"+t);if(!e)return null;const n=e.querySelector(".export-text"),o=e.querySelector(".export-status");return{wrapper:e,link:e,linkText:n,statusElement:o}}function updateProcessingLink(t,e){const n=getLinkElements(t);n&&(n.linkText.innerText=`Exporting to ${t.toUpperCase()}${".".repeat(e%4)}`,n.statusElement&&!n.statusElement.querySelector(".spinner-border")&&(n.statusElement.innerHTML='<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="sr-only">Loading...</span></div>'))}function formatDownloadLink(t,e){const n=getLinkElements(e);n&&(n.wrapper.dataset.exportStatus="SUCCESS",n.linkText.innerText=`Download ${e.toUpperCase()}`,n.statusElement&&(n.statusElement.innerHTML=`<a href="${t}" class="btn btn-sm btn-outline-primary"><i class="fas fa-download"></i></a>`),n.link.classList.remove("disabled"),n.wrapper.onclick=function(e){e.preventDefault(),e.stopPropagation(),window.location.href=t})}function resetExportLink(t){const e=getLinkElements(t);e&&(e.wrapper.dataset.exportStatus="READY",e.linkText.innerText=`Export to ${t}`,e.statusElement&&(e.statusElement.innerHTML=""),e.link.classList.remove("disabled"),e.wrapper.onclick=function(n){n.preventDefault(),n.stopPropagation(),export_to_file(e.wrapper,t)})}function lockCustomElements(){try{document.querySelectorAll(".export-format-item").forEach((t=>{t.classList.add("disabled")}))}catch(t){}}function unlockCustomElements(){try{document.querySelectorAll(".export-format-item").forEach((t=>{"READY"===t.dataset.exportStatus&&t.classList.remove("disabled")}))}catch(t){}}document.addEventListener("DOMContentLoaded",(function(){$(document).on("shown.bs.modal","#modal",(function(){initExportHandlers()}))}));