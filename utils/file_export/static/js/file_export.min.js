"use strict";const POLLING_INTERVAL_MS=500;function export_to_file(element,format){if(element.dataset.exportStatus==="READY"){element.dataset.exportStatus="PENDING";prepare_export(format).then(exportUrl=>start_export(exportUrl,format)).then(monitorUrl=>monitor_export_progress(monitorUrl,format)).catch(error=>{console.error("Export process failed:",error);resetExportLink(format)})}}async function prepare_export(format){const elements=getLinkElements(format);if(!elements){throw new Error(`Export elements for format "${format}" not found.`)}elements.link.classList.add("disabled");const element=document.getElementById("export_"+format);const baseExportUrl=element.dataset.exportUrl;const urlParams=new URLSearchParams(window.location.search);urlParams.append("format",format);return`${baseExportUrl}?${urlParams.toString()}`}async function start_export(exportUrl,format){try{const response=await fetch(exportUrl);if(!response.ok){throw new Error(`Network response was not ok: ${response.status}`)}const data=await response.json();if(!data.task_id){throw new Error("Task ID missing in export response.")}const element=document.getElementById("export_"+format);return element.dataset.exportProgressUrl.replace("0",data.task_id)}catch(error){console.error("Error starting export:",error);throw error}}async function monitor_export_progress(url,format,count=0){try{const response=await fetch(url);if(!response.ok){throw new Error(`Monitoring response was not ok: ${response.status}`)}const data=await response.json();if(data.state==="PENDING"){updateProcessingLink(format,count+1);setTimeout(()=>monitor_export_progress(url,format,count+1),POLLING_INTERVAL_MS)}else if(data.state==="SUCCESS"){cleanup_export(true,data,format)}else if(data.state==="FAILURE"){cleanup_export(false,data,format)}else{console.warn("Unexpected export state:",data.state)}}catch(error){console.error("Error monitoring export progress:",error);resetExportLink(format)}}function cleanup_export(exportSuccessful,data,format){if(exportSuccessful===true){if(data.details){formatDownloadLink(data.details,format)}else{console.error("Missing download details in export response.");resetExportLink(format)}}else{resetExportLink(format)}}function initExportHandlers(){const formatItems=document.querySelectorAll(".export-format-item");if(formatItems){formatItems.forEach(item=>{item.addEventListener("click",function(){const format=this.dataset.format;export_to_file(this,format)})})}}function getLinkElements(format){const wrapper=document.getElementById("export_"+format);if(!wrapper){return null}const linkText=wrapper.querySelector(".export-text");const statusElement=wrapper.querySelector(".export-status");return{wrapper:wrapper,link:wrapper,linkText:linkText,statusElement:statusElement}}function updateProcessingLink(format,count){const elements=getLinkElements(format);if(!elements){return}elements.linkText.innerText=`Exporting to ${format.toUpperCase()}${".".repeat(count%4)}`;if(elements.statusElement&&!elements.statusElement.querySelector(".spinner-border")){elements.statusElement.innerHTML='<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="sr-only">Loading...</span></div>'}}function formatDownloadLink(downloadUrl,format){const elements=getLinkElements(format);if(!elements){return}elements.wrapper.dataset.exportStatus="SUCCESS";elements.linkText.innerText=`Download ${format.toUpperCase()}`;if(elements.statusElement){elements.statusElement.innerHTML=`<a href="${downloadUrl}" class="btn btn-sm btn-outline-primary"><i class="fas fa-download"></i></a>`}elements.link.classList.remove("disabled");elements.wrapper.onclick=function(e){e.preventDefault();e.stopPropagation();window.location.href=downloadUrl}}function resetExportLink(format){const elements=getLinkElements(format);if(!elements){return}elements.wrapper.dataset.exportStatus="READY";elements.linkText.innerText=`Export to ${format}`;if(elements.statusElement){elements.statusElement.innerHTML=""}elements.link.classList.remove("disabled");elements.wrapper.onclick=function(e){e.preventDefault();e.stopPropagation();export_to_file(elements.wrapper,format)}}function lockCustomElements(){try{const formatItems=document.querySelectorAll(".export-format-item");formatItems.forEach(item=>{item.classList.add("disabled")})}catch(error){console.warn(`Failed to lock export links: ${error.message}`)}}function unlockCustomElements(){try{const formatItems=document.querySelectorAll(".export-format-item");formatItems.forEach(item=>{if(item.dataset.exportStatus==="READY"){item.classList.remove("disabled")}})}catch(error){console.warn(`Failed to unlock export links: ${error.message}`)}}document.addEventListener("DOMContentLoaded",function(){$(document).on("shown.bs.modal","#modal",function(){initExportHandlers()})});