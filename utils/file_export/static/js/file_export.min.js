"use strict";const POLLING_INTERVAL_MS=500;function export_to_file(t,e){"READY"===t.dataset.exportStatus&&(t.dataset.exportStatus="PENDING",prepare_export(e).then((t=>start_export(t,e))).then((t=>monitor_export_progress(t,e))).catch((t=>{console.error("Export process failed:",t),resetExportLink(e)})))}async function prepare_export(t){const e=getLinkElements(t);if(!e)throw new Error(`Export elements for format "${t}" not found.`);e.link.classList.add("disabled");const o=document.getElementById("export_"+t),r=o.dataset.exportUrl,n=window.location.search;let s=r;n&&(s+=(r.includes("?")?"&":"?")+n.slice(1));const a=new URL(s,window.location.origin);a.searchParams.set("format",t);const i=o.dataset.listType;return i&&a.searchParams.set("list_type",i),a.pathname+"?"+a.searchParams.toString()}async function start_export(t,e){try{const o=await fetch(t);if(!o.ok)throw new Error(`Network response was not ok: ${o.status}`);const r=await o.json();if(!r.task_id)throw new Error("Task ID missing in export response.");return document.getElementById("export_"+e).dataset.exportProgressUrl.replace(/\/0\//,`/${r.task_id}/`)}catch(t){throw console.error("Error starting export:",t),t}}async function monitor_export_progress(t,e,o=0){try{const r=await fetch(t);if(!r.ok)throw new Error(`Monitoring response was not ok: ${r.status}`);const n=await r.json();"PENDING"===n.state||"STARTED"===n.state?(updateProcessingLink(e,o+1,null),setTimeout((()=>monitor_export_progress(t,e,o+1)),POLLING_INTERVAL_MS)):"PROGRESS"===n.state?(updateProcessingLink(e,o+1,n.details),setTimeout((()=>monitor_export_progress(t,e,o+1)),POLLING_INTERVAL_MS)):"SUCCESS"===n.state?cleanup_export(!0,n,e):"FAILURE"===n.state?cleanup_export(!1,n,e):(console.warn("Unexpected export state:",n.state),setTimeout((()=>monitor_export_progress(t,e,o+1)),POLLING_INTERVAL_MS))}catch(t){console.error("Error monitoring export progress:",t),resetExportLink(e)}}function cleanup_export(t,e,o){!0===t?e.details?formatDownloadLink(e.details,o):(console.error("Missing download details in export response."),resetExportLink(o)):resetExportLink(o)}function initExportHandlers(){const t=document.querySelectorAll(".export-format-item");t&&t.forEach((t=>{t.addEventListener("click",(function(){export_to_file(this,this.dataset.format)}))}))}function getLinkElements(t){const e=document.getElementById("export_"+t);if(!e)return null;const o=e.querySelector(".export-text"),r=e.querySelector(".export-status");return{wrapper:e,link:e,linkText:o,statusElement:r}}function updateProcessingLink(t,e,o){const r=getLinkElements(t);if(!r)return;if(o&&o.total>0){const e=o.percent||0;r.linkText.innerText=`Exporting ${o.current} of ${o.total} records (${e}%)`,r.statusElement&&(r.statusElement.innerHTML=`<div class="progress export-progress" style="width:100px;height:8px;"><div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width:${e}%" aria-valuenow="${e}" aria-valuemin="0" aria-valuemax="100"></div></div>`)}else r.linkText.innerText=`Exporting to ${t.toUpperCase()}${".".repeat(e%4)}`,r.statusElement&&!r.statusElement.querySelector(".spinner-border")&&(r.statusElement.innerHTML='<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="sr-only">Loading...</span></div>')}function formatDownloadLink(t,e){const o=getLinkElements(e);o&&(o.wrapper.dataset.exportStatus="SUCCESS",o.linkText.innerText=`Download ${e.toUpperCase()}`,o.statusElement&&(o.statusElement.innerHTML=`<a href="${t}" class="btn btn-sm btn-outline-primary"><i class="fas fa-download"></i></a>`),o.link.classList.remove("disabled"),o.wrapper.onclick=function(e){e.preventDefault(),e.stopPropagation(),window.location.href=t})}function resetExportLink(t){const e=getLinkElements(t);e&&(e.wrapper.dataset.exportStatus="READY",e.linkText.innerText=`Export to ${t.toUpperCase()}`,e.statusElement&&(e.statusElement.innerHTML=""),e.link.classList.remove("disabled"),e.wrapper.onclick=function(o){o.preventDefault(),o.stopPropagation(),export_to_file(e.wrapper,t)})}function lockCustomElements(){try{document.querySelectorAll(".export-format-item").forEach((t=>{t.classList.add("disabled")}))}catch(t){console.warn(`Failed to lock export links: ${t.message}`)}}function unlockCustomElements(){try{document.querySelectorAll(".export-format-item").forEach((t=>{"READY"===t.dataset.exportStatus&&t.classList.remove("disabled")}))}catch(t){console.warn(`Failed to unlock export links: ${t.message}`)}}document.addEventListener("DOMContentLoaded",(function(){document.addEventListener("shown.bs.modal",(function(t){t.target&&"modal"===t.target.id&&initExportHandlers()}))}));
