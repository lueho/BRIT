{% extends 'base.html' %}
{% load crispy_forms_filters %}

{% block content %}
    {% load leaflet_tags %}
    {% load crispy_forms_tags %}

    {% leaflet_js plugins="draw" %}
    {% leaflet_css plugins="draw" %}

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Hamburg Roadside Trees</h1>
    </div>

    <!-- Outer Wrapper -->
    <div class="row h-100">

        <!-- Filter Form -->
        <div class="col-sm-3">
            <h3>Search Filter:</h3>
            <div>
                <form method="get">
                    {{ form|crispy }}
                </form>
                <button class="btn btn-primary" id="button_tree_type" onclick="queryDatasets()">Submit</button>
            </div>
            <div>
                <h3>Summary:</h3>
                <table>
                    <tr>
                        <td>Tree count:</td>
                        <td id="result-tree-count"></td>
                    </tr>
                </table>
            </div>
        </div>
        <!-- End Filter Form -->

        <!-- Map Column -->
        <div class="col col-sm-9">
        {% leaflet_map "main" %}
        </div>
        <!-- End Map Column -->

    </div>
    <!-- End Outer Wrapper -->

{% endblock content %}

{% block javascript %}
    {{ block.super }}

    <script type="text/javascript">

        let map;
        let myRenderer = L.canvas({padding: 0.5});
        let tree_layer;
        let region_layer;

        window.addEventListener("map:init", function (event) {
            map = event.detail.map;
        });

        async function fetchRegionGeometry() {

            // Define query string for REST API
            let params = L.Util.extend({
                region_id: 3
            });

            let url = "{% url 'ajax_region_geometries' %}" + L.Util.getParamString(params);

            // Remove existing layer
            if (region_layer !== undefined) {
                map.removeLayer(region_layer);
            }

            // Fetch data from REST API
            let response = await fetch(url);
            let data = await response.json();

            // Render geodata on map
            let geodata;
            geodata = data['geoJson'];
            region_layer = L.geoJson(geodata, {
                style: region_layer_style
            })
            region_layer.addTo(map);
            map.fitBounds(region_layer.getBounds())
        }


        async function queryDatasets() {

            // Define query string for REST API
            let params = L.Util.extend({
                gattung_deutsch: document.getElementById("id_gattung_deutsch").value,
                bezirk: document.getElementById("input_bezirk").value,
                pflanzjahr_min: document.getElementById("id_pflanzjahr_min").value,
                pflanzjahr_max: document.getElementById("id_pflanzjahr_max").value,
            });

            let dataurl = "{% url 'data.hamburg_roadside_trees' %}" + L.Util.getParamString(params);

            // Remove existing layer
            if (tree_layer !== undefined) {
                map.removeLayer(tree_layer);
            }

            // Fetch data from REST API
            let response = await fetch(dataurl);
            let data = await response.json();
            console.log(data);

            // Render geodata on map
            let geodata = data['geoJson'];
            tree_layer = L.geoJson(geodata, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        renderer: myRenderer,
                        color: '#63c36c',
                        fillOpacity: 1,
                        radius: 5,
                        stroke: false
                    })
                },
                onEachFeature: function onEachFeature(feature, layer) {
                }
            }).addTo(map);

            // Fill "Results" section with analysis data from the analysis dict
            let analysis = data['analysis'];

            $("#result-tree-count")[0].innerHTML = analysis['tree_count'].toString();
        }

        function onLoad() {
            fetchRegionGeometry();
            map.invalidateSize();
        }

        window.onload = () => onLoad();

    </script>
{% endblock %}
