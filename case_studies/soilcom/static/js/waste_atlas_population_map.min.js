var WasteAtlasPopulationMap=function(){"use strict";var t,e,a=[{label:"Urban (> 1 500 / km²)",color:"#ffea46",test:function(t){return t>1500}},{label:"Suburban (300 – 1 500 / km²)",color:"#7d7c78",test:function(t){return t>=300&&t<=1500}},{label:"Rural (< 300 / km²)",color:"#00204d",test:function(t){return t<300}}],n="#e0e0e0",r={};function o(t){t&&(t.style.display="none")}function l(t){return fetch(t,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw new Error(e.status+" "+e.statusText+" — "+t);return e.json()}))}function i(o){o;var l=Array.isArray(o.population)?o.population:o.population.results||[];e={},l.forEach((function(t){e[t.catchment_id]=t})),o.catchments.features&&o.catchments.features.forEach((function(t){var a=t.properties.catchment_id,n=e[a];t.properties.population_density=n?n.population_density:null,t.properties.population=n?n.population:null}));var i=document.getElementById(r.containerId).clientWidth||900,s=Math.round(1.17*i);(t=d3.select("#"+r.svgId).attr("xmlns","http://www.w3.org/2000/svg").attr("width",i).attr("height",s).style("background","#fff")).selectAll("*").remove();var c=d3.geoMercator().fitExtent([[40,60],[i-40,s-100]],o.catchments),d=d3.geoPath().projection(c);o.countryBorder&&o.countryBorder.features&&t.append("g").attr("class","layer-country").selectAll("path").data(o.countryBorder.features).enter().append("path").attr("d",d).attr("fill","#f0f0f0").attr("stroke","#333333").attr("stroke-width",2),o.bundeslaender&&o.bundeslaender.features&&t.append("g").attr("class","layer-bundeslaender").selectAll("path").data(o.bundeslaender.features).enter().append("path").attr("d",d).attr("fill","none").attr("stroke","#666666").attr("stroke-width",1.2),o.catchments.features&&t.append("g").attr("class","layer-catchments").selectAll("path").data(o.catchments.features).enter().append("path").attr("d",d).attr("fill",(function(t){var e=function(t){if(null==t||isNaN(t))return null;for(var e=0;e<a.length;e++)if(a[e].test(t))return a[e];return null}(t.properties.population_density);return e?e.color:n})).attr("stroke","#000000").attr("stroke-width",.3).append("title").text((function(t){var e=t.properties,a=null!=e.population_density?Math.round(e.population_density).toLocaleString()+" / km²":"no data";return e.catchment_name+" — "+a})),t.append("text").attr("x",i/2).attr("y",30).attr("text-anchor","middle").attr("font-family","'Nunito', sans-serif").attr("font-size",18).attr("font-weight","bold").text("Population Density per Waste Collection Catchment — Germany"),function(e,r){var o=40,l=r-80,i=22,s=16,c=6,d=t.append("g").attr("class","atlas-legend").attr("transform","translate("+o+","+l+")"),u=a.length*(s+c)+c+20;d.append("rect").attr("x",-8).attr("y",-20).attr("width",300).attr("height",u).attr("fill","white").attr("fill-opacity",.9).attr("stroke","#ccc").attr("rx",4),d.append("text").attr("x",0).attr("y",-4).attr("font-weight","bold").attr("font-size",12).text("Population density"),a.forEach((function(t,e){var a=e*(s+c);d.append("rect").attr("x",0).attr("y",a+4).attr("width",i).attr("height",s).attr("fill",t.color).attr("stroke","#333"),d.append("text").attr("x",i+8).attr("y",a+4+s-3).attr("font-size",12).text(t.label)}));var p=a.length*(s+c);d.append("rect").attr("x",0).attr("y",p+4).attr("width",i).attr("height",s).attr("fill",n).attr("stroke","#333"),d.append("text").attr("x",i+8).attr("y",p+4+s-3).attr("font-size",12).text("No data")}(0,s);var u=o.catchments.features?o.catchments.features.length:0;t.append("text").attr("x",i/2).attr("y",50).attr("text-anchor","middle").attr("font-family","'Nunito', sans-serif").attr("font-size",13).attr("fill","#666").text(u+" catchments")}function s(){var t=document.getElementById(r.svgId),e=(new XMLSerializer).serializeToString(t);return e.match(/^<svg[^>]+xmlns/)||(e=e.replace("<svg",'<svg xmlns="http://www.w3.org/2000/svg"')),'<?xml version="1.0" standalone="no"?>\r\n'+e}function c(t,e){var a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)}function d(){var t=s();c(new Blob([t],{type:"image/svg+xml;charset=utf-8"}),"waste_atlas_population_density.svg")}function u(){var t=document.getElementById(r.svgId),e=parseInt(t.getAttribute("width"),10),a=parseInt(t.getAttribute("height"),10),n=3.125,o=document.createElement("canvas");o.width=e*n,o.height=a*n;var l=o.getContext("2d");l.scale(n,n);var i=new Image,d=s(),u="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(d);i.onload=function(){l.fillStyle="#fff",l.fillRect(0,0,o.width,o.height),l.drawImage(i,0,0,e,a),o.toBlob((function(t){c(t,"waste_atlas_population_density.png")}),"image/png")},i.src=u}return{init:function(t){r=t;var e=document.getElementById(t.loadingId),a=document.getElementById("btn-export-svg"),n=document.getElementById("btn-export-png"),s=document.getElementById("btn-load");function c(r,s){var c;(c=e)&&(c.style.display=""),a.disabled=!0,n.disabled=!0,function(t,e){var a="/waste_collection/api/waste-atlas/",n=a+"catchment/geojson/?country="+t+"&year="+e,r=a+"population/?country="+t+"&year="+e,o="/maps/api/nuts_region/geojson/?cntr_code="+t,i="/maps/api/nuts_region/geojson/?levl_code=1&cntr_code="+t;return Promise.all([l(n),l(r),l(o),l(i)]).then((function(t){return{catchments:t[0],population:t[1],countryBorder:t[2],bundeslaender:t[3]}}))}(r,s).then((function(t){i(t),o(e),a.disabled=!1,n.disabled=!1})).catch((function(a){o(e),console.error("Waste Atlas load error:",a),document.getElementById(t.containerId).innerHTML='<div class="alert alert-danger m-3"><strong>Error loading map data:</strong> '+a.message+"</div>"}))}c(t.country,t.year),s.addEventListener("click",(function(){c(document.getElementById("sel-country").value,parseInt(document.getElementById("sel-year").value,10)||2022)})),a.addEventListener("click",d),n.addEventListener("click",u)},exportSVG:d,exportPNG:u}}();