"use strict";const fieldConfig={catchment:{include:!0,format:t=>t||""},collector:{include:!0,format:t=>t||""},collection_system:{include:!0,format:t=>t||""},waste_category:{include:!0,format:t=>t||""},allowed_materials:{include:!0,format:t=>{if(!t)return"";const e=Array.isArray(t)?t.join(", "):t;return formatList(e,", ")}},forbidden_materials:{include:!0,format:t=>{if(!t)return"";const e=Array.isArray(t)?t.join(", "):t;return formatList(e,", ")}},fee_system:{include:!0,format:t=>t||""},population:{include:!1,format:t=>t?t.toLocaleString():""},population_density:{include:!1,format:t=>t?t.toFixed(2):""},comments:{include:!1,format:t=>formatList(t,"; ")},valid_from:{include:!1,format:t=>t?new Date(t).toLocaleDateString():""},lastmodified_at:{include:!1,format:t=>t?new Date(t).toLocaleDateString():""},sources:{include:!0,format:t=>{const e=formatUrls(t);return e?`<ul class="list-disc pl-4">${e}</ul>`:""}}};function enableBtn(t){t&&(t.classList.remove("disabled"),t.removeAttribute("aria-disabled"),t.removeAttribute("tabindex"),t.title&&-1!==t.title.indexOf("Select a collection")&&t.removeAttribute("title"))}function disableBtn(t,e){t&&(t.classList.add("disabled"),t.setAttribute("aria-disabled","true"),t.setAttribute("tabindex","-1"),e&&t.setAttribute("title",e))}function getScope(){return(new URLSearchParams(window.location.search).get("scope")||"published").toLowerCase()}function getContextFlag(t){try{const e=document.getElementById("map-context");if(!e)return null;const n=e.dataset[t];if(void 0===n)return null;if("true"===n)return!0;if("false"===n)return!1}catch(t){return null}}function getCurrentUserId(){try{const t=document.getElementById("map-context");if(!t)return null;const e=t.dataset.userId;if(!e)return null;const n=parseInt(e,10);return Number.isNaN(n)?null:n}catch(t){return null}}function hideSelectionHint(){const t=document.getElementById("map-actions-hint");t&&t.classList.add("d-none")}let __wc_lastSelectedLayer=null;function resetFeatureStyles(t){try{if(!t)return;t.eachLayer((t=>{t&&"function"==typeof t.setStyle&&"object"==typeof featuresLayerStyle&&t.setStyle(featuresLayerStyle)})),__wc_lastSelectedLayer=null}catch(t){}}function selectFeature(t){try{if(!t)return;if(__wc_lastSelectedLayer&&"function"==typeof __wc_lastSelectedLayer.setStyle&&"object"==typeof featuresLayerStyle&&__wc_lastSelectedLayer.setStyle(featuresLayerStyle),__wc_lastSelectedLayer=t,"function"==typeof t.setStyle){const e=Object.assign({},featuresLayerStyle||{},{color:"#FF6600",weight:featuresLayerStyle&&"number"==typeof featuresLayerStyle.weight?Math.max(2,featuresLayerStyle.weight+3):5,fillOpacity:featuresLayerStyle&&"number"==typeof featuresLayerStyle.fillOpacity?Math.min(1,featuresLayerStyle.fillOpacity+.15):.65});t.setStyle(e)}try{"function"==typeof t.bringToFront&&t.bringToFront()}catch(t){}}catch(t){}}function featureClickHandler(t,e){const n={type:"Point",coordinates:[t.latlng.lng,t.latlng.lat]},o=new Set;try{e.eachLayer((t=>{try{if(t&&t.toGeoJSON&&t instanceof L.Polygon){const e=t.toGeoJSON(),a=e&&e.geometry?{type:"Feature",geometry:e.geometry,properties:{}}:null;a&&turf.inside(n,a)&&o.add(t)}}catch(t){}}))}catch(t){}try{t&&t.layer&&t.layer.feature&&t.layer instanceof L.Polygon&&o.add(t.layer)}catch(t){}let a="No features found",r="";if(0===o.size);else if(1===o.size){const t=[...o][0],e=t.feature&&t.feature.properties?t.feature.properties.id:null;null!=e&&void 0!==window.SelectionController?window.SelectionController.select(e,t):(selectFeature(t),null!=e&&getFeatureDetails(e));try{a=t.feature.properties.catchment;const n=t.feature.properties.waste_category,o=t.feature.properties.collection_system;r=`<a href="${getDetailUrlForId(e)}">${n} - ${o}</a>`}catch(t){}}else{try{a=[...o][0].feature.properties.catchment}catch(t){}r=[...o].map((t=>{try{const e=t.feature.properties.id,n=t.feature.properties.waste_category;return`<a href="javascript:void(0)" onclick="window.__wc_selectFromPopup(${e})">${n} - ${t.feature.properties.collection_system}</a>`}catch(t){return""}})).filter(Boolean).join("<br>")}try{map.openPopup(`<strong>${a}</strong><br/>${r}`,t.latlng,{offset:L.point(0,-24)})}catch(t){}}function createFeatureLayerBindings(t){t.bindTooltip((function(t){return t.feature.properties.catchment.toString()})),t.bindPopup((function(t){return t.feature.properties.catchment.toString()}));try{window.featuresLayer=t}catch(t){}t.on("click",(e=>featureClickHandler(e,t)))}function getDetailUrlForId(t){try{const e=document.getElementById("btn-collection-detail"),n=e&&e.dataset&&e.dataset.hrefTemplate;if(!n)return"#";let o;try{o=parseFilterParameters()}catch(t){o=new URLSearchParams(window.location.search)}try{o.set("scope",getScope())}catch(t){}o.set("load_features","true");const a=window.location.pathname+"?"+o.toString(),r=new URLSearchParams;r.set("next",a);const c=n.replace("__pk__",String(t)),i=-1===c.indexOf("?")?"?":"&";return c+i+r.toString()}catch(t){return"#"}}function highlightFeatureById(t,e){try{const n=e||(void 0!==window.featuresLayer?window.featuresLayer:null);if(!n||"function"!=typeof n.eachLayer)return;n.eachLayer((e=>{try{const n=e&&e.feature&&e.feature.properties;n&&String(n.id)===String(t)&&selectFeature(e)}catch(t){}}))}catch(t){}}window.__wc_selectFromPopup=function(t){try{void 0!==window.SelectionController?window.SelectionController.select(t):(highlightFeatureById(t,void 0!==window.featuresLayer?window.featuresLayer:null),getFeatureDetails(t))}catch(t){}try{"undefined"!=typeof map&&map&&"function"==typeof map.closePopup&&map.closePopup()}catch(t){}};const SelectionController=function(){let t=null;return{select:function(e,n){try{t=String(e)}catch(n){t=e}try{n?selectFeature(n):highlightFeatureById(e,void 0!==window.featuresLayer?window.featuresLayer:null)}catch(t){}try{ButtonManager.reset()}catch(t){}try{showSummaryLoading()}catch(t){}try{getFeatureDetails(e)}catch(t){}try{window.dispatchEvent(new CustomEvent("wc-selection-changed",{detail:{id:t}}))}catch(t){}},getSelectedId:function(){return t}}}();try{window.SelectionController=SelectionController}catch(t){}function showSummaryLoading(){try{const t=document.getElementById("summary-container");t&&(t.innerHTML='<div class="text-center my-3"><div class="spinner-border text-secondary" role="status" aria-label="Loading"><span class="visually-hidden">Loading...</span></div></div>')}catch(t){}}function clearSummary(){try{const t=document.getElementById("summary-container");t&&(t.innerHTML='<p class="card-text">No data selected, yet.</p>')}catch(t){}}function scrollToSummaries(){const t=document.getElementById("filter_result_card");t&&t.scrollIntoView({behavior:"smooth",block:"start"})}function updateUrls(t){let e;try{e=parseFilterParameters()}catch(t){e=new URLSearchParams(window.location.search)}e.set("load_features","true");try{e.set("scope",getScope())}catch(t){}const n=window.location.pathname+"?"+e.toString(),o=new URLSearchParams;o.set("next",n);try{const t=document.getElementById("btn-collection-create"),e=t.dataset.hrefTemplate+"?"+o.toString();t.setAttribute("href",e)}catch(t){console.warn(`Create button not updated: ${t}`)}try{const e=document.getElementById("btn-collection-detail"),n=e.dataset.hrefTemplate.replace("__pk__",t.toString());e.setAttribute("href",n),e.classList.remove("d-none")}catch(t){console.warn(`Detail button not updated: ${t}`)}try{const e=document.getElementById("btn-collection-update"),n=e.dataset.hrefTemplate.replace("__pk__",t.toString())+"?"+o.toString();e.setAttribute("href",n)}catch(t){console.warn(`Update button not updated: ${t}`)}try{const e=document.getElementById("btn-collection-copy"),n=e.dataset.hrefTemplate.replace("__pk__",t.toString())+"?"+o.toString();e.setAttribute("href",n)}catch(t){console.warn(`Copy button not updated: ${t}`)}try{const e=document.getElementById("btn-collection-delete"),n=e.dataset.hrefTemplate.replace("__pk__",t.toString())+"?"+o.toString();e.setAttribute("href",n);try{e.classList.remove("bmf-bound")}catch(t){}try{"function"==typeof window.wireModalLinks?window.wireModalLinks():"function"==typeof window.modalForm&&window.modalForm(e,{formURL:n,modalID:"#modal",errorClass:".is-invalid"})}catch(t){}}catch(t){console.warn(`Delete button not updated: ${t}`)}hideSelectionHint();try{const t=document.getElementById("btn-clear-selection");t&&t.classList.remove("d-none")}catch(t){}}function addDetailViewButton(){}function clickedPrivateMapButton(){const t=document.getElementById("link-map-private");window.location.href=t.dataset.hrefTemplate+"?"+parseFilterParameters().toString()}function clickedPublicMapButton(){const t=document.getElementById("link-map-public");console.log(t.dataset.hrefTemplate),window.location.href=t.dataset.hrefTemplate+"?"+parseFilterParameters().toString()}function clickedListButton(){const t=document.getElementById("btn-collections-as-list");window.location.href=t.dataset.hrefTemplate+"?"+parseFilterParameters().toString()}function clickedListLink(){const t=document.getElementById("link-collections-as-list");window.location.href=t.dataset.hrefTemplate+"?"+parseFilterParameters().toString()}function adaptMapConfig(){mapConfig.layerOrder=["features","region","catchment"]}!function(){const t="function"==typeof window.getFeatureDetails?window.getFeatureDetails:null;t&&(window.getFeatureDetails=async function(e){try{showSummaryLoading()}catch(t){}return await t(e)})}(),function(){const t="function"==typeof window.getFeaturesLayerFilterParameters?window.getFeaturesLayerFilterParameters:null;window.getFeaturesLayerFilterParameters=function(){let e;try{e=t?t():new URLSearchParams(window.location.search)}catch(t){e=new URLSearchParams(window.location.search)}try{const t=function(){try{const t=document.getElementById("map-context");return t&&t.dataset.dv||null}catch(t){return null}}();t&&e.set("dv",t)}catch(t){}return e}}(),function(){let t=null;const e="function"==typeof window.fetchFeatureDetails?window.fetchFeatureDetails:null;window.fetchFeatureDetails=async function(n){try{try{t&&t.abort()}catch(t){}t=new AbortController;let o="object"==typeof n?n.id||n.properties&&n.properties.id:n;if(o=String(o),!Number.isInteger(parseInt(o)))return console.warn("Invalid feature id:",o),e?e(n):Promise.reject(new Error("Invalid feature id"));const a=window.mapConfig&&window.mapConfig.featuresLayerDetailsUrlTemplate||"";if(!a)return e?e(n):Promise.reject(new Error("Missing details URL template"));let r=a+o+"/";try{const t="function"==typeof window.getScope?window.getScope():new URLSearchParams(window.location.search).get("scope")||"published",e=-1===r.indexOf("?")?"?":"&";r=r+e+"scope="+encodeURIComponent(t)}catch(t){}const c=await fetch(r,{signal:t.signal});if(!c.ok)throw new Error("HTTP "+c.status);return await c.json()}catch(t){if(t&&"AbortError"===t.name)return new Promise((()=>{}));if(console.warn("fetchFeatureDetails override failed, delegating to original:",t),e)return e(n);throw t}}}();const ButtonManager={apply:function(t){try{const e=function(){let t;try{t=parseFilterParameters()}catch(e){t=new URLSearchParams(window.location.search)}try{t.set("scope",getScope())}catch(t){}t.set("load_features","true");const e=window.location.pathname+"?"+t.toString(),n=new URLSearchParams;return n.set("next",e),n}();try{const n=document.getElementById("btn-collection-detail");if(n){const o=n.dataset.hrefTemplate;if(o){const a=o.replace("__pk__",t.id),r=-1===a.indexOf("?")?"?":"&";n.setAttribute("href",a+r+e.toString()),n.classList.remove("d-none")}else n.classList.add("d-none")}}catch(t){}try{const n=document.getElementById("btn-collection-update");if(n){const o=n.dataset.hrefTemplate;o&&n.setAttribute("href",o.replace("__pk__",t.id)+"?"+e.toString())}}catch(t){}try{const n=document.getElementById("btn-collection-copy");if(n){const o=n.dataset.hrefTemplate;o&&n.setAttribute("href",o.replace("__pk__",t.id)+"?"+e.toString())}}catch(t){}try{const n=document.getElementById("btn-collection-delete");if(n){const o=n.dataset.hrefTemplate;if(o){const a=o.replace("__pk__",t.id)+"?"+e.toString();n.setAttribute("href",a);try{n.classList.remove("bmf-bound")}catch(t){}try{"function"==typeof window.wireModalLinks?window.wireModalLinks():"function"==typeof window.modalForm&&window.modalForm(n,{formURL:a,modalID:"#modal",errorClass:".is-invalid"})}catch(t){}}}}catch(t){}const n=t&&t.policy?t.policy:null;try{console.debug("[WC] policy from server:",n)}catch(t){}let o=!1,a=!1,r=!1;if(n)o=!!n.can_edit,a=!!n.can_delete,r=!!n.can_duplicate;else try{console.warn("[WC] Missing policy in feature details; actions remain disabled.")}catch(t){}try{console.debug("[WC] computed button perms:",{canUpdate:o,canDelete:a,canCopy:r})}catch(t){}const c=document.getElementById("btn-collection-update"),i=document.getElementById("btn-collection-delete"),l=document.getElementById("btn-collection-copy");c&&(o?enableBtn(c):disableBtn(c,"You do not have permission to edit this item.")),i&&(a?enableBtn(i):disableBtn(i,"You do not have permission to delete this item.")),l&&(r?enableBtn(l):disableBtn(l,"You do not have permission to copy this item."))}catch(t){console.warn("ButtonManager.apply failed:",t)}},reset:function(){try{disableBtn(document.getElementById("btn-collection-copy"),"Select a collection on the map first")}catch(t){}try{disableBtn(document.getElementById("btn-collection-update"),"Select a collection on the map first")}catch(t){}try{disableBtn(document.getElementById("btn-collection-delete"),"Select a collection on the map first")}catch(t){}try{const t=document.getElementById("btn-collection-detail");t&&t.classList.add("d-none")}catch(t){}try{const t=document.getElementById("map-actions-hint");t&&t.classList.remove("d-none")}catch(t){}try{const t=document.getElementById("btn-clear-selection");t&&t.classList.add("d-none")}catch(t){}}};function clearSelection(){try{__wc_lastSelectedLayer&&"function"==typeof __wc_lastSelectedLayer.setStyle&&"object"==typeof featuresLayerStyle&&__wc_lastSelectedLayer.setStyle(featuresLayerStyle),__wc_lastSelectedLayer=null}catch(t){}try{ButtonManager.reset()}catch(t){}clearSummary();try{"undefined"!=typeof map&&map&&"function"==typeof map.closePopup&&map.closePopup()}catch(t){}try{window.dispatchEvent(new CustomEvent("wc-selection-cleared"))}catch(t){}}!function(){const t="function"==typeof window.renderFeatureDetails?window.renderFeatureDetails:null;window.renderFeatureDetails=function(e){try{t&&t(e)}catch(t){console.warn("Original renderFeatureDetails failed:",t)}try{ButtonManager.apply(e)}catch(t){console.warn("ButtonManager.apply hook failed:",t)}}}();