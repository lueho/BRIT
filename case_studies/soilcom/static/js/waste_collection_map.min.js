"use strict";const fieldConfig={catchment:{include:!0,format:e=>e||""},collector:{include:!0,format:e=>e||""},collection_system:{include:!0,format:e=>e||""},waste_category:{include:!0,format:e=>e||""},allowed_materials:{include:!0,format:e=>{if(!e)return"";const t=Array.isArray(e)?e.join(", "):e;return formatList(t,", ")}},forbidden_materials:{include:!0,format:e=>{if(!e)return"";const t=Array.isArray(e)?e.join(", "):e;return formatList(t,", ")}},fee_system:{include:!0,format:e=>e||""},population:{include:!1,format:e=>e?e.toLocaleString():""},population_density:{include:!1,format:e=>e?e.toFixed(2):""},comments:{include:!1,format:e=>formatList(e,"; ")},valid_from:{include:!1,format:e=>e?new Date(e).toLocaleDateString():""},lastmodified_at:{include:!1,format:e=>e?new Date(e).toLocaleDateString():""},sources:{include:!0,format:e=>{const t=formatUrls(e);return t?`<ul class="list-disc pl-4">${t}</ul>`:""}}};function britEnableBtn(e){e&&(e.classList.remove("disabled"),e.removeAttribute("aria-disabled"),e.removeAttribute("tabindex"),e.title&&-1!==e.title.indexOf("Select a collection")&&e.removeAttribute("title"))}function britDisableBtn(e,t){e&&(e.classList.add("disabled"),e.setAttribute("aria-disabled","true"),e.setAttribute("tabindex","-1"),t&&e.setAttribute("title",t))}function getScope(){return(new URLSearchParams(window.location.search).get("scope")||"published").toLowerCase()}function getContextFlag(e){try{const t=document.getElementById("map-context");if(!t)return null;const n=t.dataset[e];return void 0===n?null:"true"===n||"false"!==n&&n}catch(e){return null}}function isStaffUser(){return!0===getContextFlag("isStaff")}function getCurrentUserId(){try{const e=document.getElementById("map-context");if(!e)return null;const t=e.dataset.userId;if(!t)return null;const n=parseInt(t,10);return Number.isNaN(n)?null:n}catch(e){return null}}function hideSelectionHint(){const e=document.getElementById("map-actions-hint");e&&e.classList.add("d-none")}let __wc_lastSelectedLayer=null;function resetFeatureStyles(e){try{if(!e)return;e.eachLayer((e=>{e&&"function"==typeof e.setStyle&&"object"==typeof featuresLayerStyle&&e.setStyle(featuresLayerStyle)})),__wc_lastSelectedLayer=null}catch(e){}}function selectFeature(e){try{if(!e)return;if(__wc_lastSelectedLayer&&"function"==typeof __wc_lastSelectedLayer.setStyle&&"object"==typeof featuresLayerStyle&&__wc_lastSelectedLayer.setStyle(featuresLayerStyle),__wc_lastSelectedLayer=e,"function"==typeof e.setStyle){const t=Object.assign({},featuresLayerStyle||{},{color:"#FF6600",weight:featuresLayerStyle&&"number"==typeof featuresLayerStyle.weight?Math.max(1,featuresLayerStyle.weight+2):4,fillOpacity:featuresLayerStyle&&"number"==typeof featuresLayerStyle.fillOpacity?Math.min(1,featuresLayerStyle.fillOpacity+.1):.6});e.setStyle(t)}}catch(e){}}function featureClickHandler(e,t){if(resetFeatureStyles(t),e&&e.layer&&e.layer.feature){const t=e.layer;selectFeature(t);const n=t.feature.properties||{};null!=n.id&&getFeatureDetails(n.id);try{const t=n.catchment,r=n.waste_category,a=n.collection_system,o=`<a href="javascript:void(0)" onclick="getFeatureDetails(${n.id})">${r} - ${a}</a>`;map.openPopup(`<strong>${t}</strong><br/>${o}`,e.latlng,{offset:L.point(0,-24)})}catch(e){}return}const n=new Set;t.eachLayer((t=>{if(t instanceof L.Polygon){const r=t.toGeoJSON(),a=[e.latlng.lng,e.latlng.lat];turf.inside(a,r)&&n.add(t)}}));let r="No features found",a="";if(1===n.size){const e=[...n][0];selectFeature(e);const t=e.feature.properties.id;null!=t&&getFeatureDetails(t),r=e.feature.properties.catchment;a=`<a href="javascript:void(0)" onclick="getFeatureDetails(${t})">${e.feature.properties.waste_category} - ${e.feature.properties.collection_system}</a>`}else n.size>1&&(r=[...n][0].feature.properties.catchment,a=[...n].map((e=>{const t=e.feature.properties.waste_category,n=e.feature.properties.collection_system;return selectFeature(e),`<a href="javascript:void(0)" onclick="getFeatureDetails(${e.feature.properties.id})">${t} - ${n}</a><br>`})).join(""));map.openPopup(`<strong>${r}</strong><br/>${a}`,e.latlng,{offset:L.point(0,-24)})}function createFeatureLayerBindings(e){e.bindTooltip((function(e){return e.feature.properties.catchment.toString()})),e.bindPopup((function(e){return e.feature.properties.catchment.toString()})),e.on("click",(t=>featureClickHandler(t,e)))}function scrollToSummaries(){const e=document.getElementById("filter_result_card");e&&e.scrollIntoView({behavior:"smooth",block:"start"})}function updateUrls(e){let t;try{t=parseFilterParameters()}catch(e){t=new URLSearchParams(window.location.search)}t.set("load_features","true");try{t.set("scope",getScope())}catch(e){}const n=window.location.pathname+"?"+t.toString(),r=new URLSearchParams;r.set("next",n);try{const e=document.getElementById("btn-collection-create"),t=e.dataset.hrefTemplate+"?"+r.toString();e.setAttribute("href",t)}catch(e){console.warn(`Create button not updated: ${e}`)}try{const t=document.getElementById("btn-collection-detail"),n=t.dataset.hrefTemplate.replace("__pk__",e.toString());t.setAttribute("href",n),t.classList.remove("d-none")}catch(e){console.warn(`Detail button not updated: ${e}`)}try{const t=document.getElementById("btn-collection-update"),n=t.dataset.hrefTemplate.replace("__pk__",e.toString())+"?"+r.toString();t.setAttribute("href",n)}catch(e){console.warn(`Update button not updated: ${e}`)}try{const t=document.getElementById("btn-collection-copy"),n=t.dataset.hrefTemplate.replace("__pk__",e.toString())+"?"+r.toString();t.setAttribute("href",n)}catch(e){console.warn(`Copy button not updated: ${e}`)}try{const t=document.getElementById("btn-collection-delete"),n=t.dataset.hrefTemplate.replace("__pk__",e.toString())+"?"+r.toString();t.setAttribute("href",n);try{t.classList.remove("bmf-bound")}catch(e){}try{"function"==typeof window.wireModalLinks?window.wireModalLinks():"function"==typeof window.modalForm&&window.modalForm(t,{formURL:n,modalID:"#modal",errorClass:".is-invalid"})}catch(e){}}catch(e){console.warn(`Delete button not updated: ${e}`)}try{britEnableBtn(document.getElementById("btn-collection-copy"))}catch(e){}hideSelectionHint()}function addDetailViewButton(){}function clickedPrivateMapButton(){const e=document.getElementById("link-map-private");window.location.href=e.dataset.hrefTemplate+"?"+parseFilterParameters().toString()}function clickedPublicMapButton(){const e=document.getElementById("link-map-public");console.log(e.dataset.hrefTemplate),window.location.href=e.dataset.hrefTemplate+"?"+parseFilterParameters().toString()}function clickedListButton(){const e=document.getElementById("btn-collections-as-list");window.location.href=e.dataset.hrefTemplate+"?"+parseFilterParameters().toString()}function clickedListLink(){const e=document.getElementById("link-collections-as-list");window.location.href=e.dataset.hrefTemplate+"?"+parseFilterParameters().toString()}function adaptMapConfig(){mapConfig.layerOrder=["features","region","catchment"]}!function(){const e="function"==typeof window.getFeaturesLayerFilterParameters?window.getFeaturesLayerFilterParameters:null;window.getFeaturesLayerFilterParameters=function(){let t;try{t=e?e():new URLSearchParams(window.location.search)}catch(e){t=new URLSearchParams(window.location.search)}try{const e=function(){try{const e=document.getElementById("map-context");return e&&e.dataset.dv||null}catch(e){return null}}();e&&t.set("dv",e)}catch(e){}return t}}(),function(){const e="function"==typeof window.fetchFeatureDetails?window.fetchFeatureDetails:null;window.fetchFeatureDetails=async function(t){try{let n="object"==typeof t?t.id||t.properties&&t.properties.id:t;if(n=String(n),!Number.isInteger(parseInt(n)))return console.warn("Invalid feature id:",n),e?e(t):Promise.reject(new Error("Invalid feature id"));const r=window.mapConfig&&window.mapConfig.featuresLayerDetailsUrlTemplate||"";if(!r)return e?e(t):Promise.reject(new Error("Missing details URL template"));let a=r+n+"/";try{const e="function"==typeof window.getScope?window.getScope():new URLSearchParams(window.location.search).get("scope")||"published",t=-1===a.indexOf("?")?"?":"&";a=a+t+"scope="+encodeURIComponent(e)}catch(e){}const o=await fetch(a);if(!o.ok)throw new Error("HTTP "+o.status);return await o.json()}catch(n){if(console.warn("fetchFeatureDetails override failed, delegating to original:",n),e)return e(t);throw n}}}(),function(){const e="function"==typeof window.renderFeatureDetails?window.renderFeatureDetails:null;window.renderFeatureDetails=function(t){try{e&&e(t)}catch(e){console.warn("Original renderFeatureDetails failed:",e)}try{const e=String(t&&t.publication_status||"").toLowerCase(),n=isStaffUser(),r=t&&null!=t.owner_id?String(t.owner_id):null,a=getCurrentUserId(),o=!(!r||null==a||String(a)!==r),i="published"===e,c="archived"===e,l=!c&&(n||o&&!i),s=c&&n||!c&&(i&&n||!i&&(o||n)),u=document.getElementById("btn-collection-update"),d=document.getElementById("btn-collection-delete");u&&(l?britEnableBtn(u):britDisableBtn(u,"You do not have permission to edit this item.")),d&&(s?britEnableBtn(d):britDisableBtn(d,"You do not have permission to delete this item."))}catch(e){console.warn("Failed to toggle Edit/Delete availability:",e)}}}();