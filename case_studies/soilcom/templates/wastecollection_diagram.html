{% extends "base.html" %}
{% load static %}

{% block title %}
    BRIT | Waste Collection Module Diagram
{% endblock title %}

{% block custom_style %}
    <style>
        .diagram-container {
            background: #fff;
            border: 1px solid var(--bs-border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            overflow-x: auto;
        }
        .diagram-container .node rect,
        .diagram-container .node polygon,
        .diagram-container .node circle {
            cursor: pointer;
        }
        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 1.5rem;
            font-size: 0.85rem;
        }
        .legend-line {
            width: 2rem;
            height: 0;
            display: inline-block;
            margin-right: 0.4rem;
            vertical-align: middle;
        }
        .legend-line--fk {
            border-top: 2px solid #666;
        }
        .legend-line--m2m {
            border-top: 2px dashed #666;
        }
        .legend-swatch {
            width: 1rem;
            height: 1rem;
            border-radius: 3px;
            display: inline-block;
            margin-right: 0.4rem;
            vertical-align: middle;
        }
        .legend-swatch--clickable {
            background: #dbeafe;
            border: 2px solid #1e40af;
        }
        .legend-swatch--internal {
            background: #f3f4f6;
            border: 2px solid #9ca3af;
        }
    </style>
{% endblock custom_style %}

{% block content %}
    <div class="mb-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
                <h2 class="mb-1">Waste Collection Module &mdash; Model Diagram</h2>
                <p class="text-muted mb-0">Click on any highlighted model to open its list view.</p>
            </div>
            <a href="{% url 'wastecollection-explorer' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Back to Explorer
            </a>
        </div>
    </div>

    <div class="mb-3">
        <span class="legend-item"><span class="legend-swatch legend-swatch--clickable"></span> Browsable model (click to open)</span>
        <span class="legend-item"><span class="legend-swatch legend-swatch--internal"></span> Internal model</span>
        <span class="legend-item"><span class="legend-line legend-line--fk"></span> Foreign key</span>
        <span class="legend-item"><span class="legend-line legend-line--m2m"></span> Many-to-many</span>
    </div>

    <div class="diagram-container">
        <pre class="mermaid">
%%{init: {'securityLevel': 'loose', 'theme': 'default', 'flowchart': {'curve': 'basis', 'nodeSpacing': 30, 'rankSpacing': 60}}}%%
flowchart TD

    subgraph core["Collections &amp; Geography"]
        Collection["Collection"]
        CollectionCatchment["CollectionCatchment"]
        Collector["Collector"]
    end

    subgraph config["Classification &amp; Configuration"]
        WasteCategory["WasteCategory"]
        CollectionSystem["CollectionSystem"]
        FeeSystem["FeeSystem"]
        CollectionFrequency["CollectionFrequency"]
    end

    subgraph streams["Waste Streams &amp; Components"]
        WasteStream["WasteStream"]
        WasteComponent["WasteComponent"]
    end

    subgraph sources["Sources &amp; Data"]
        WasteFlyer["WasteFlyer"]
        CollectionPropertyValue["CollectionPropertyValue"]
        AggCollPropValue["AggregatedCollection\nPropertyValue"]
    end

    subgraph scheduling["Scheduling"]
        CollectionSeason["CollectionSeason"]
        CollectionCountOptions["CollectionCountOptions"]
    end

    %% ---- FK relationships (solid) ----
    Collection -->|"collector"| Collector
    Collection -->|"catchment"| CollectionCatchment
    Collection -->|"collection_system"| CollectionSystem
    Collection -->|"waste_stream"| WasteStream
    Collection -->|"frequency"| CollectionFrequency
    Collection -->|"fee_system"| FeeSystem
    Collector -->|"catchment"| CollectionCatchment
    WasteStream -->|"category"| WasteCategory
    CollectionPropertyValue -->|"collection"| Collection
    CollectionCountOptions -->|"frequency"| CollectionFrequency
    CollectionCountOptions -->|"season"| CollectionSeason

    %% ---- M2M relationships (dashed) ----
    Collection -.-|"flyers"| WasteFlyer
    Collection -.-|"samples"| Sample_ext["Sample &#40;ext&#41;"]
    Collection -.-|"predecessors"| Collection
    WasteStream -.-|"allowed_materials"| WasteComponent
    WasteStream -.-|"forbidden_materials"| WasteComponent
    WasteStream -.-|"composition"| SampleSeries_ext["SampleSeries &#40;ext&#41;"]
    AggCollPropValue -.-|"collections"| Collection

    %% ---- Styling ----
    classDef clickable fill:#dbeafe,stroke:#1e40af,stroke-width:2px,color:#1e3a5f
    classDef internal fill:#f3f4f6,stroke:#9ca3af,stroke-width:1px,color:#4b5563
    classDef external fill:#fef9c3,stroke:#ca8a04,stroke-width:1px,color:#713f12,font-style:italic

    class Collection,CollectionCatchment,Collector clickable
    class WasteCategory,CollectionSystem,FeeSystem,CollectionFrequency clickable
    class WasteComponent,WasteFlyer clickable
    class WasteStream,CollectionSeason,CollectionCountOptions,CollectionPropertyValue,AggCollPropValue internal
    class Sample_ext,SampleSeries_ext external

    %% ---- Click handlers ----
    click Collection href "{% url 'collection-list' %}" _self
    click CollectionCatchment href "{% url 'collectioncatchment-list' %}" _self
    click Collector href "{% url 'collector-list' %}" _self
    click WasteCategory href "{% url 'wastecategory-list' %}" _self
    click CollectionSystem href "{% url 'collectionsystem-list' %}" _self
    click FeeSystem href "{% url 'feesystem-list' %}" _self
    click CollectionFrequency href "{% url 'collectionfrequency-list' %}" _self
    click WasteComponent href "{% url 'wastecomponent-list' %}" _self
    click WasteFlyer href "{% url 'wasteflyer-list' %}" _self
        </pre>
    </div>
{% endblock content %}

{% block javascript %}
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            mermaid.initialize({
                startOnLoad: true,
                securityLevel: 'loose',
                theme: 'default',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true,
                    curve: 'basis',
                },
            });
        });
    </script>
{% endblock javascript %}
