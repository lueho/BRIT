{% extends "detail_with_options.html" %}
{% load i18n %}
{% load moderation_tags %}
{% load static %}
{% load file_export_tags %}

{# Confirm texts available to all blocks #}
{% trans "Are you sure you want to submit this for review?" as submit_confirm %}
{% trans "Are you sure you want to withdraw this from review?" as withdraw_confirm %}
{% trans "Are you sure you want to approve this?" as approve_confirm %}
{% trans "Are you sure you want to reject this?" as reject_confirm %}

{% block detail_header_badge %}
{% include "object_management/review_status_badge.html" with object=object %}
{% endblock detail_header_badge %}

{% block detail_header_actions %}
  <div class="btn-toolbar" role="toolbar" aria-label="Detail actions">
    <div class="btn-group me-2" role="group">
      {% if request.GET.back %}
      <a class="btn btn-sm btn-outline-secondary" href="{{ request.GET.back }}" title="Back to results">
        <i class="fas fa-arrow-left"></i> <span class="d-none d-md-inline">Back to results</span>
      </a>
      {% else %}
        {% if object.list_url %}
        <a class="btn btn-sm btn-outline-secondary" href="{{ object.list_url }}" title="List">
          <i class="fas fa-list-ul"></i> <span class="d-none d-md-inline">List</span>
        </a>
        {% else %}
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'collection-list' %}" title="List">
          <i class="fas fa-list-ul"></i> <span class="d-none d-md-inline">List</span>
        </a>
        {% endif %}
      {% endif %}
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'wastecollection-dashboard' %}" title="Open Explorer (dashboard)">
        <i class="fas fa-table-cells-large"></i> <span class="d-none d-md-inline">Explorer</span>
      </a>
    </div>
    <div class="btn-group me-2" role="group">
      {% if request.user.is_authenticated %}
        {% if request.user == object.owner and object.is_declined and not review_mode %}
          <a class="btn btn-sm btn-outline-danger" href="{% url 'object_management:review_item_detail' content_type_id=object|get_content_type_id object_id=object.id %}" title="Review feedback">
            <i class="fas fa-clipboard-check"></i> <span class="d-none d-sm-inline">Review feedback</span>
          </a>
        {% endif %}
      {% endif %}
    </div>
  </div>
  {# Reject Modal kept near header to support header actions #}
  {% if object.is_in_review %}
    {% if user.is_staff %}
      <div class="modal fade" id="rejectModal-{{ object.id }}" tabindex="-1" aria-labelledby="rejectModalLabel-{{ object.id }}" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="rejectModalLabel-{{ object.id }}">{% trans "Reject item" %}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans "Close" %}"></button>
            </div>
            <form method="post" action="{% url 'object_management:reject_item' content_type_id=object|get_content_type_id object_id=object.id %}?next={{ request.get_full_path|urlencode }}">
              <div class="modal-body">
                  {% csrf_token %}
                  <p class="mb-3">{{ reject_confirm }}</p>
                  <div class="mb-3">
                    <label for="reject-comment-textarea-{{ object.id }}" class="form-label">{% trans "Review comment (optional)" %}</label>
                    <textarea class="form-control" id="reject-comment-textarea-{{ object.id }}" name="comment" rows="4" placeholder="{% trans "Explain why this was rejected (optional)" %}"></textarea>
                  </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="submit" class="btn btn-danger">
                  <i class="fas fa-xmark"></i> {% trans "Reject" %}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% elif perms.can_moderate %}
      <div class="modal fade" id="rejectModal-{{ object.id }}" tabindex="-1" aria-labelledby="rejectModalLabel-{{ object.id }}" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="rejectModalLabel-{{ object.id }}">{% trans "Reject item" %}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans "Close" %}"></button>
            </div>
            <form method="post" action="{% url 'object_management:reject_item' content_type_id=object|get_content_type_id object_id=object.id %}?next={{ request.get_full_path|urlencode }}">
              <div class="modal-body">
                  {% csrf_token %}
                  <p class="mb-3">{{ reject_confirm }}</p>
                  <div class="mb-3">
                    <label for="reject-comment-textarea-{{ object.id }}" class="form-label">{% trans "Review comment (optional)" %}</label>
                    <textarea class="form-control" id="reject-comment-textarea-{{ object.id }}" name="comment" rows="4" placeholder="{% trans "Explain why this was rejected (optional)" %}"></textarea>
                  </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="submit" class="btn btn-danger">
                  <i class="fas fa-xmark"></i> {% trans "Reject" %}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}
{% endblock %}

{% block detail_body %}
    <p class="card-text">
       <strong>Catchment:</strong><br>
          <a href="{{ object.catchment.get_absolute_url }}">{{ object.catchment.name }}</a>
    </p>
    <p class="card-text">
         <strong>Collector:</strong><br>
          <a href="{{ object.collector.get_absolute_url }}">{{ object.collector.name }}</a>
    </p>
    <p class="card-text">
        <strong>Collection System:</strong><br>
          <a href="{{ object.collection_system.get_absolute_url }}">{{ object.collection_system.name }}</a>
    </p>
    <p class="card-text">
        <strong>Waste Category:</strong><br>
          <a href="{{ object.waste_stream.category.get_absolute_url }}">{{ object.waste_stream.category }}</a>
    </p>
    <p class="card-text">
        <strong>Year:</strong><br>
        {{ object.valid_from|date:"Y" }}
    </p>
        {% if object.connection_type %}
    <p class="card-text">
        <strong>Connection Type:</strong><br>
          {% if object.connection_type == 'MANDATORY' %}
            Mandatory
          {% elif object.connection_type == 'VOLUNTARY' %}
            Voluntary
          {% elif object.connection_type == 'MANDATORY_WITH_HOME_COMPOSTER_EXCEPTION' %}
            Mandatory with exception for home composters
          {% elif object.connection_type == 'not_specified' %}
        Not specified
        {% else %}
        {{ object.connection_type }}
        {% endif %}
    </p>
    {% endif %}
        {% if object.min_bin_size %}
    <p class="card-text">
        <strong>Smallest available bin size (L):</strong><br>
          {{ object.min_bin_size }} L
    </p>
        {% endif %}

        {% if object.required_bin_capacity %}
    <p class="card-text">
        <strong>Required bin capacity:</strong><br>
          {{ object.required_bin_capacity }} L
          {% if object.required_bin_capacity_reference %}
            {% if object.required_bin_capacity_reference == 'not_specified' %}
              <span class="text-muted">(reference not specified)</span>
            {% else %}
              <span class="text-muted">per {{ object.required_bin_capacity_reference }}</span>
            {% endif %}
          {% endif %}
    </p>
        {% endif %}

  {% if object.waste_stream.allowed_materials.exists %}
    <p class="card-text"><strong>Allowed Materials:</strong></p>
    <ul>
        {% for material in object.waste_stream.allowed_materials.all %}
          <li><a href="{{ material.get_absolute_url }}">{{ material }}</a></li>
        {% endfor %}
      </ul>
    {% endif %}
  {% if object.waste_stream.forbidden_materials.exists %}
    <p class="card-text"><strong>Forbidden Materials:</strong></p>
    <ul>
        {% for material in object.waste_stream.forbidden_materials.all %}
          <li><a href="{{ material.get_absolute_url }}">{{ material }}</a></li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if object.frequency %}
    <p class="card-text"><strong>Frequency:</strong><br>
        Total number of collections per season:</p>
    <ul>
        {% for opt in object.frequency.collectioncountoptions_set.all %}
          <li>
            {{ opt.season }}: Standard: {{ opt.standard }}
            {% if opt.non_standard_options %}
              (Options:
              {% for non_standard_option in opt.non_standard_options %}
                {{ non_standard_option }}{% if not forloop.last %}, {% endif %}
              {% endfor %})
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if object.fee_system %}
    <p class="card-text">
        <strong>Fee System:</strong><br>
        {{ object.fee_system.name }}
    </p>
    {% endif %}

    {% if object.collectionpropertyvalue_set.exists %}
      {% regroup object.collectionpropertyvalue_set.all by property as property_list %}
      {% for prop in property_list %}
    <p class="card-text"><strong>{{ prop.grouper.name|title }}:</strong></p>
    <ul>
          {% for val in prop.list|dictsortreversed:"year" %}
        <li><a href="{{ val.get_absolute_url }}">
                {% if val.standard_deviation %}
                {{ val.average }} ± {{ val.standard_deviation }} {{ val.unit.name }} (
            {{ val.year }})
                {% else %}
                  {{ val.average }} {{ val.unit.name }} ({{ val.year }})
                {% endif %}
        </a></li>
          {% endfor %}
        </ul>
      {% endfor %}
    {% endif %}

    {% if object.aggregatedcollectionpropertyvalue_set.exists %}
      {% regroup object.aggregatedcollectionpropertyvalue_set.all by property as property_list %}
      {% for prop in property_list %}
    <p class="card-text"><strong>{{ prop.grouper.name|title }}:</strong></p>
    <ul>
          {% for val in prop.list|dictsortreversed:"year" %}
        <li><a href="{{ val.get_absolute_url }}">
                {% if val.standard_deviation %}
                {{ val.average }} ± {{ val.standard_deviation }} {{ val.unit.name }} (
            {{ val.year }}) (aggregated)
                {% else %}
                  {{ val.average }} {{ val.unit.name }} ({{ val.year }}) (aggregated)
                {% endif %}
        </a></li>
          {% endfor %}
        </ul>
      {% endfor %}
    {% endif %}

    {% if object.samples.exists %}
    <p class="card-text"><strong>Samples</strong></p>
    <ul>
        {% for sample in object.samples.all %}
          <li><a href="{{ sample.get_absolute_url }}">{{ sample.name }}</a></li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if object.flyers.exists %}
    <p class="card-text"><strong>Sources:</strong></p>
    <ul>
        {% for flyer in object.flyers.all %}
        <li><a href="{{ flyer.url }}" target="blank">{{ flyer.url }}</a></li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if object.description %}
    <p class="card-text"><strong>Comments:</strong><br>{{ object.description }}</p>
    {% endif %}

    <p class="card-text">
        <strong>Valid from:</strong><br>
        {{ object.valid_from|date:"d.m.Y" }}
    </p>
    <p class="card-text">
        <strong>Valid until:</strong><br>
        {{ object.valid_until|date:"d.m.Y" }}
    </p>

    <p class="card-text">
        <strong>Last update:</strong><br>
        {{ object.lastmodified_at|date:"d.m.Y" }}
    </p>
    {% if object.predecessors.exists %}
    <strong>Predecessors:</strong><br>
    <ul>
        {% for predecessor_collection in object.predecessors.all %}
        <li>
            <a href="{{ predecessor_collection.get_absolute_url }}">{{ predecessor_collection }}</a>
        </li>
        {% endfor %}
      </ul>
    {% endif %}
    {% if object.successors.exists %}
    <strong>Successors:</strong><br>
    <ul>
        {% for successor_collection in object.successors.all %}
        <li>
            <a href="{{ successor_collection.get_absolute_url }}">{{ successor_collection }}</a>
        </li>
        {% endfor %}
      </ul>
    {% endif %}
{% endblock detail_body %}

{# Options for the integrated right column (new base) #}
{% block options_pane %}
  {# CRUD #}
  {% if object.update_url and not object.is_archived %}
    {% if request.user.is_staff %}
      <a class="btn btn-primary w-100 mb-2" href="{{ object.update_url }}?next={{ request.get_full_path|urlencode }}">
        <i class="fas fa-pen-to-square"></i> Edit
      </a>
    {% elif request.user == object.owner and object.publication_status != object.STATUS_PUBLISHED %}
      <a class="btn btn-primary w-100 mb-2" href="{{ object.update_url }}?next={{ request.get_full_path|urlencode }}">
        <i class="fas fa-pen-to-square"></i> Edit
      </a>
    {% endif %}
  {% endif %}

  {% if request.user.is_authenticated %}
    {% if not object.is_archived %}
      {% if request.user == object.owner or request.user.is_staff %}
        <a class="btn btn-outline-secondary w-100 mb-2" href="{% url 'collection-wastesamples' object.id %}">
          <i class="fas fa-pen-to-square"></i> Manage samples
        </a>
        <a class="btn btn-outline-secondary w-100 mb-2" href="{% url 'collection-add-property' object.id %}">
          <i class="fas fa-circle-plus"></i> Add property
        </a>
      {% endif %}
    {% endif %}
  {% endif %}

  {% if 'soilcom.add_collection' in perms %}
    <a class="btn btn-outline-secondary w-100 mb-2" href="{% url 'collection-copy' object.id %}">
      <i class="fas fa-copy"></i> Duplicate
    </a>
    <a class="btn btn-outline-secondary w-100 mb-2" href="{% url 'collection-new-version' object.id %}">
      <i class="fas fa-code-branch"></i> New version
    </a>
  {% endif %}

  {% if object.publication_status == object.STATUS_PUBLISHED %}
    {% if request.user == object.owner or request.user.is_staff %}
      <a class="btn btn-outline-secondary modal-link w-100 mb-2" href="{% url 'collection-archive-modal' object.id %}">
        <i class="fas fa-archive"></i> Archive
      </a>
    {% endif %}
  {% endif %}

  {# Delete with published vs private rules (hidden for archived objects) #}
  {% if object.modal_delete_url and not object.is_archived %}
    {% if object.publication_status == object.STATUS_PUBLISHED %}
      {% if request.user.is_staff %}
        <a class="btn btn-outline-danger modal-link w-100 mb-2" href="{{ object.modal_delete_url }}{% if request.GET.back %}?next={{ request.GET.back|urlencode }}{% endif %}">
          <i class="fas fa-trash"></i> Delete
        </a>
      {% endif %}
    {% else %}
      {% if request.user == object.owner or request.user.is_staff %}
        <a class="btn btn-outline-danger modal-link w-100 mb-2" href="{{ object.modal_delete_url }}{% if request.GET.back %}?next={{ request.GET.back|urlencode }}{% endif %}">
          <i class="fas fa-trash"></i> Delete
        </a>
      {% endif %}
    {% endif %}
  {% endif %}

  {# Review workflow #}
  {% if object.is_private %}
    {% if request.user == object.owner or request.user.is_staff %}
      <form method="post" action="{% url 'object_management:submit_for_review' content_type_id=object|get_content_type_id object_id=object.id %}?next={{ request.get_full_path|urlencode }}" class="m-0 p-0 mb-2">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-primary w-100" onclick="return confirm('{{ submit_confirm }}')">
          <i class="fas fa-paper-plane"></i> {% trans "Submit for Review" %}
        </button>
      </form>
    {% endif %}
  {% endif %}

  {% if object.is_in_review %}
    {% if request.user == object.owner or request.user.is_staff %}
      <form method="post" action="{% url 'object_management:withdraw_from_review' content_type_id=object|get_content_type_id object_id=object.id %}?next={{ request.get_full_path|urlencode }}" class="m-0 p-0 mb-2">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-warning w-100" onclick="return confirm('{{ withdraw_confirm }}')">
          <i class="fas fa-rotate-left"></i> {% trans "Withdraw from Review" %}
        </button>
      </form>
    {% endif %}
    {% if request.user.is_staff or perms.can_moderate %}
      <form method="post" action="{% url 'object_management:approve_item' content_type_id=object|get_content_type_id object_id=object.id %}?next={{ request.get_full_path|urlencode }}" class="m-0 p-0 mb-2">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-success w-100" onclick="return confirm('{{ approve_confirm }}')">
          <i class="fas fa-check"></i> {% trans "Approve" %}
        </button>
      </form>
      <button type="button" class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#rejectModal-{{ object.id }}">
        <i class="fas fa-xmark"></i> {% trans "Reject" %}
      </button>
    {% endif %}
  {% endif %}

  {# Export #}
  {% if request.user.is_authenticated %}
    {% if object.publication_status == object.STATUS_PUBLISHED %}
      <a class="btn btn-outline-secondary modal-link w-100" href="{% export_link_modal 'collection-export' list_type='public' %}">
        <i class="fas fa-file-export"></i> Export data
      </a>
    {% elif request.user == object.owner or request.user.is_staff %}
      <a class="btn btn-outline-secondary modal-link w-100" href="{% export_link_modal 'collection-export' list_type='private' %}">
        <i class="fas fa-file-export"></i> Export data
      </a>
    {% endif %}
  {% endif %}
{% endblock options_pane %}

{# Learning tab content (new base) #}
{% block learning_content %}
  {% include "soilcom/includes/learning_materials.html" %}
{% endblock learning_content %}

{# Legacy block preserved but disabled #}
{% block second_row %}{% endblock second_row %}

{% block detail_with_options_scripts %}
  <script src="{% static 'js/file_export.min.js' %}" type="text/javascript"></script>
{% endblock detail_with_options_scripts %}