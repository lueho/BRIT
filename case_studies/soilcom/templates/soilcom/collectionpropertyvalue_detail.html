{% extends "detail_with_options.html" %}
{% load moderation_tags %}

{% object_policy object as policy %}

{% block detail_header_badge %}
    {% include "object_management/review_status_badge.html" with object=object %}
{% endblock detail_header_badge %}

{% block detail_header_actions %}
    <div class="btn-toolbar" role="toolbar" aria-label="Detail actions">
        <div class="btn-group me-2" role="group">
            <a class="btn btn-sm btn-outline-secondary"
               href="{{ object.collection.get_absolute_url }}"
               title="Collection">
                <i class="fas fa-arrow-left"></i>
                <span class="d-none d-md-inline">Collection</span>
            </a>
            {% if object.list_url %}
                <a class="btn btn-sm btn-outline-secondary"
                   href="{{ object.list_url }}"
                   title="List">
                    <i class="fas fa-list-ul"></i>
                    <span class="d-none d-md-inline">List</span>
                </a>
            {% endif %}
        </div>
        {{ block.super }}
    </div>
{% endblock detail_header_actions %}

{% block detail_body %}
    <p class="card-text">
        <strong>Collection:</strong>
        <br>
        <a href="{{ object.collection.get_absolute_url }}">{{ object.collection }}</a>
    </p>
    {% with anchor=object.collection.version_anchor %}
        {% if anchor and anchor.pk != object.collection.pk %}
            <p class="card-text">
                <strong>Anchor collection:</strong>
                <br>
                <a href="{{ anchor.get_absolute_url }}">{{ anchor }}</a>
            </p>
        {% endif %}
    {% endwith %}
    <p class="card-text">
        <strong>Property:</strong>
        <br>
        {{ object.property }}
    </p>
    <p class="card-text">
        <strong>Year:</strong>
        <br>
        {{ object.year }}
    </p>
    {% if object.standard_deviation %}
        <p class="card-text">
            <strong>Value:</strong>
            <br>
            {{ object.average }}
            Â± {{ object.standard_deviation }} {{ object.unit }}
        </p>
    {% else %}
        <p class="card-text">
            <strong>Value:</strong>
            <br>
            {{ object.average }} {{ object.unit }}
        </p>
    {% endif %}
    {% if object.sources.exists %}
        <p class="card-text">
            <strong>Sources:</strong>
        </p>
        <ul>
            {% for source in object.sources.all %}
                <li>
                    {% if source.type == "waste_flyer" %}
                        {# Waste flyer: Display as clickable URL with document icon #}
                        <i class="fas fa-file-alt text-muted"></i>
                        <span class="badge bg-secondary text-white me-2">Waste Flyer</span>
                        <a href="{{ source.url }}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="text-break">
                            {{ source.url }}
                            <i class="fas fa-external-link-alt ms-1 small"></i>
                        </a>
                    {% else %}
                        {# Regular bibliographic source #}
                        <a href="{{ source.get_absolute_url }}">{{ source.abbreviation }}</a>
                        {% if source.title %}- {{ source.title }}{% endif %}
                        {% if source.year %}({{ source.year }}){% endif %}
                        {% if source.url %}
                            <br>
                            <span class="text-muted small">
                                <a href="{{ source.url }}" target="_blank" rel="noopener noreferrer">
                                    <i class="fas fa-external-link-alt"></i> {{ source.url }}
                                </a>
                            </span>
                        {% endif %}
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <p class="card-text">
        <strong>Owner:</strong>
        <br>
        {{ object.owner }}
    </p>
    {% if object.publication_status != 'published' %}
        <p class="card-text text-muted small">
            {% if object.publication_status == 'private' %}
                Visible only to you (owner) and moderators until submitted.
            {% elif object.publication_status == 'review' %}
                Awaiting moderator review.
            {% elif object.publication_status == 'declined' %}
                Changes were declined; update and resubmit after addressing feedback.
            {% endif %}
        </p>
    {% endif %}
    {% object_policy object as policy %}
    {% if policy.can_submit_review or policy.can_withdraw_review or policy.can_approve or policy.can_reject %}
        <div class="mt-3 d-flex flex-wrap gap-2">
            {% if policy.can_submit_review %}
                <a class="btn btn-outline-primary modal-link"
                   href="{% url 'object_management:submit_for_review_modal' content_type_id=object|get_content_type_id object_id=object.id %}?next={{ request.get_full_path|urlencode }}">
                    <i class="fas fa-paper-plane"></i>
                    Submit for review
                </a>
            {% endif %}
            {% if policy.can_withdraw_review %}
                <a class="btn btn-outline-warning modal-link"
                   href="{% url 'object_management:withdraw_from_review_modal' content_type_id=object|get_content_type_id object_id=object.id %}?next={{ request.get_full_path|urlencode }}">
                    <i class="fas fa-rotate-left"></i>
                    Withdraw
                </a>
            {% endif %}
            {% if policy.can_approve or policy.can_reject %}
                <a class="btn btn-outline-secondary"
                   href="{% url 'object_management:review_item_detail' content_type_id=object|get_content_type_id object_id=object.id %}?next={{ object.get_absolute_url|urlencode }}">
                    <i class="fas fa-clipboard-check"></i>
                    Open review view
                </a>
            {% endif %}
        </div>
    {% endif %}
{% endblock detail_body %}

{% block detail_footer %}
    {% block back_button %}
        <a href="{{ object.collection.get_absolute_url }}"
           onclick="history.back(); return false;"
           class="nowrap">
            <i class="fas fa-fw fa-arrow-left">
            </i> back
        </a>
    {% endblock back_button %}
    {% block list_link %}
        {% if object.list_url %}
            <a href="{{ object.list_url }}" class="ms-3">
                <i class="fas fa-fw fa-list">
                </i> See all
            </a>
        {% endif %}
    {% endblock list_link %}
    {% if policy.can_edit or policy.can_delete %}
        {% block update_link %}
            {% if policy.can_edit and object.update_url %}
                <a href="{{ object.update_url }}" class="ms-3">
                    <i class="fas fa-fw fa-edit">
                    </i> Edit
                </a>
            {% endif %}
        {% endblock update_link %}
        {% block delete_link %}
            {% if policy.can_delete and object.modal_delete_url %}
                <a href="{{ object.modal_delete_url }}" class="modal-link ms-3">
                    <i class="fas fa-fw fa-trash">
                    </i> Delete
                </a>
            {% endif %}
        {% endblock delete_link %}
    {% endif %}
    {% block additional_footer_links %}
    {% endblock additional_footer_links %}
{% endblock detail_footer %}
