{% extends "filtered_map.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load file_export_tags %}

{% block custom_style %}
  {{ block.super }}
{% endblock custom_style %}

{% block map_card_header %}
  <span>{{ map_title }}</span>
  <span class="text-muted small ms-2">({{ total_count }} results)</span>
{% endblock map_card_header %}

{% block map_card_header_actions %}
  <div class="btn-group btn-group-sm" role="group" aria-label="View toggle">
    <a class="btn btn-outline-secondary"
       id="link-collections-as-list"
       href="{% if list_type == 'private' %}{{ object_list.model.private_list_url }}{% elif list_type == 'review' %}{{ object_list.model.review_list_url }}{% else %}{{ object_list.model.public_list_url }}{% endif %}?{% for key, value in request.GET.items %}{% if key != 'id' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}">
      List
    </a>
    <a class="btn btn-outline-secondary active disabled"
       aria-current="page"
       href="#">Map</a>
  </div>
  {% if user.is_authenticated %}
    <div class="btn-group btn-group-sm" role="group" aria-label="Scope toggle">
      <a class="btn btn-outline-secondary {% if list_type == 'published' %}active disabled{% endif %}"
         href="{{ object_list.model.public_map_url }}?{% for key, value in request.GET.items %}{% if key != 'scope' and key != 'id' and key != 'page' and key != 'publication_status' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}scope=published">
        Published
      </a>
      <a class="btn btn-outline-secondary {% if list_type == 'private' %}active disabled{% endif %}"
         href="{{ object_list.model.private_map_url }}?{% for key, value in request.GET.items %}{% if key != 'scope' and key != 'id' and key != 'page' and key != 'publication_status' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}scope=private">
        My
      </a>
      {% if user.is_staff or perms.soilcom.can_moderate_collection %}
        <a class="btn btn-outline-secondary {% if list_type == 'review' %}active disabled{% endif %}"
           href="{{ object_list.model.review_map_url }}?{% for key, value in request.GET.items %}{% if key != 'scope' and key != 'id' and key != 'page' and key != 'publication_status' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}scope=review">
          Review
        </a>
      {% endif %}
    </div>
  {% endif %}
  {{ block.super }}
{% endblock map_card_header_actions %}

{% block user_actions %}
  <div class="card shadow">
    <div class="card-header p-0 border-0 bg-body-tertiary">
      <ul class="nav nav-pills sidebar-tabs px-3 pt-3 pb-2"
          id="sidebarTabs"
          role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active"
                  id="filters-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#filters-pane"
                  type="button"
                  role="tab"
                  aria-controls="filters-pane"
                  aria-selected="true">
            <i class="fas fa-filter"></i> Filters
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link"
                  id="options-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#options-pane"
                  type="button"
                  role="tab"
                  aria-controls="options-pane"
                  aria-selected="false">
            <i class="fas fa-gear"></i> Options
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link"
                  id="learning-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#learning-pane"
                  type="button"
                  role="tab"
                  aria-controls="learning-pane"
                  aria-selected="false">
            <i class="fas fa-graduation-cap"></i> Learning
          </button>
        </li>
      </ul>
    </div>
    <div class="card-body">
      <div class="tab-content">
        <div class="tab-pane fade show active"
             id="filters-pane"
             role="tabpanel"
             aria-labelledby="filters-tab"
             tabindex="0">
          <form method="get">
            {% crispy filter.form %}
            <div class="d-flex justify-content-end gap-2 mt-2">
              <button class="btn btn-primary submit-filter"
                      id="filter-button"
                      type="button"
                      onclick="clickedFilterButton()">Filter</button>
              <a class="btn btn-outline-secondary"
                 href="{% if list_type == 'private' %}{{ object_list.model.private_map_url }}?scope=private{% elif list_type == 'review' %}{{ object_list.model.review_map_url }}?scope=review{% else %}{{ object_list.model.public_map_url }}?scope=published{% endif %}"
                 aria-label="Reset filters">Reset</a>
            </div>
          </form>
        </div>
        <div class="tab-pane fade"
             id="options-pane"
             role="tabpanel"
             aria-labelledby="options-tab"
             tabindex="0">
          {% if perms.soilcom.add_collection or user.is_staff %}
            <a id="btn-collection-create"
               class="btn btn-success w-100 mb-2"
               href="{{ object_list.model.create_url }}"
               data-href-template="{{ object_list.model.create_url }}"
               aria-label="Add new {{ object_list.model.get_verbose_name }}">
              <i class="fas fa-plus"></i> Create new {{ object_list.model.get_verbose_name }}
            </a>
          {% endif %}

          {% if "soilcom.add_aggregatedcollectionpropertyvalue" in perms %}
            <a class="btn btn-outline-secondary w-100 mb-2"
               href="{% url 'aggregatedcollectionpropertyvalue-create' %}">
              <i class="fas fa-circle-plus"></i> Add property to collection group
            </a>
          {% endif %}

          {% export_modal_button "collection-export" list_type=list_type button_classes="btn btn-outline-secondary w-100" %}

          <p id="map-actions-hint" class="text-muted small mb-2">Select a collection on the map to enable actions.</p>

          {% if perms.soilcom.add_collection %}
            <a id="btn-collection-copy"
               class="btn btn-outline-secondary disabled w-100 mt-3"
               data-href-template="/waste_collection/collections/__pk__/copy/"
               href="#"
               role="button"
               aria-disabled="true"
               tabindex="-1"
               title="Select a collection on the map first">Copy selected collection</a>
          {% endif %}

          {% if user.is_authenticated %}
            <a id="btn-collection-update"
               class="btn btn-outline-secondary disabled w-100 mt-2"
               href="#"
               role="button"
               data-href-template="/waste_collection/collections/__pk__/update/"
               aria-disabled="true"
               tabindex="-1"
               title="Select a collection on the map first">Edit selected collection</a>
          {% endif %}
          {% if user.is_authenticated %}
            <a id="btn-collection-delete"
               class="btn btn-danger modal-link disabled w-100 mt-2"
               href="#"
               role="button"
               data-href-template="/waste_collection/collections/__pk__/delete/modal/"
               aria-disabled="true"
               tabindex="-1"
               title="Select a collection on the map first">Delete selected collection</a>
          {% endif %}
        </div>
        <div class="tab-pane fade"
             id="learning-pane"
             role="tabpanel"
             aria-labelledby="learning-tab"
             tabindex="0">{% include "soilcom/includes/learning_materials.html" %}</div>
      </div>
    </div>
  </div>
  <div class="card shadow" id="filter_result_card">
    <div class="card-header"
         role="button"
         data-bs-toggle="collapse"
         href="#info-card-body"
         aria-expanded="true"
         aria-controls="info-card-body">
      <b>Summary</b>
    </div>
    <div class="card-body collapse show" id="info-card-body">
      <div id="summary-container">
        <p class="card-text">No data selected, yet.</p>
      </div>
      {% if object.sources.first %}
        <p class="card-text mt-3">
          <strong>Sources:</strong>
          <br>
          {% for source in object.sources.all %}
            <a href="{% url 'source-detail-modal' source.id %}" class="modal-link">
              {{ source.abbreviation }}
              {% if not forloop.last %},{% endif %}
            </a>
          {% endfor %}
        </p>
      {% endif %}
      <div class="text-center">
        <a id="btn-collection-detail"
           class="btn btn-primary w-75 d-none"
           data-href-template="/waste_collection/collections/__pk__/"
           href="#">Full Details</a>
      </div>
      <div class="text-center mt-2">
        <button id="btn-clear-selection"
                type="button"
                class="btn btn-outline-secondary w-75 d-none"
                onclick="clearSelection()">Clear selection</button>
      </div>
    </div>
  </div>
  <div id="map-context"
       data-is-staff="{{ user.is_staff|yesno:'true,false' }}"
       data-user-id="{{ request.user.id }}"
       data-dv="{{ dataset_version }}"
       hidden></div>
{% endblock user_actions %}

{% block javascript %}
  {{ block.super }}
  <script src="{% static 'lib/turf-inside/inside.min.js' %}"></script>
  <script src="{% static 'js/waste_collection_map.min.js' %}"></script>
  <script src="{% static 'js/file_export.min.js' %}"></script>
{% endblock javascript %}
