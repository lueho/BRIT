{% extends "waste_atlas/choropleth_map.html" %}

{% block atlas_config %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    WasteAtlasChoropleth.init({
      svgId:       'atlas-svg',
      containerId: 'map-container',
      loadingId:   'loading-overlay',
      country:     '{{ country }}',
      year:        parseInt('{{ year }}', 10) || 2022,
      title:       'Verhältnis Bioabfall zu Gesamtabfall',
      dataUrl:     '/waste_collection/api/waste-atlas/waste-ratio/',
      dataField:   '_classified',
      categories: [
        { value: 'very_high', label: 'Über 0,66 (Viel mehr Bio als Rest)',   color: '#0868ac' },
        { value: 'high',      label: '0,51 – 0,66 (Mehr Bio als Rest)',      color: '#43a2ca' },
        { value: 'low',       label: '0,34 – 0,50 (Mehr Rest als Bio)',      color: '#7bccc4' },
        { value: 'very_low',  label: '0,00 – 0,33 (Geringer Bio-Anteil)',    color: '#bae4bc' },
        { value: 'no_bio',    label: 'Keine separate Bioabfallsammlung',      color: '#fff696' }
      ],
      noDataColor: '#ffffff',
      noDataLabel: 'Keine Daten',
      legendTitle: 'Bio / (Bio + Rest)',
      fileBase:    'karte19_sammelmengen_verhaeltnis',
      transformData: function (records) {
        return records.map(function (r) {
          var cls;
          if (r.ratio === null) {
            if (r.bio_amount === null && r.residual_amount !== null) {
              cls = 'no_bio';
            } else {
              cls = null;
            }
          } else if (r.ratio > 0.66) {
            cls = 'very_high';
          } else if (r.ratio > 0.50) {
            cls = 'high';
          } else if (r.ratio > 0.33) {
            cls = 'low';
          } else {
            cls = 'very_low';
          }
          return { catchment_id: r.catchment_id, _classified: cls };
        });
      }
    });
  });
</script>
{% endblock atlas_config %}
