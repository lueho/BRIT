{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load crispy_forms_filters %}
{% load leaflet_tags %}

{% block title %}Maps | Catchments{% endblock %}

{% block content %}

    {% leaflet_js plugins="draw" %}
    {% leaflet_css plugins="draw" %}

    <div class="row">

        <div class="col">
            <div class="card shadow">
                <div class="card-header"><strong>Catchments</strong></div>
                <div class="card-body p-0">
                    {% leaflet_map "main" %}
                </div>
            </div>
        </div>

        <div class="col-sm-3">
            <div class="accordion">
                <div class="card shadow tab-card">
                    <div class="card-header" role="button" data-toggle="collapse"
                         href="#filter-card-body"
                         aria-expanded="true" aria-controls="filter-card-body">
                        <strong>Filter</strong>
                    </div>
                    <div class="card-header tab-card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="filter-tabs"
                            role="tablist">
                            <li class="nav-item">
                                <a class="nav-link"
                                   id="nuts-filter-tab"
                                   data-toggle="tab"
                                   href="#nuts-filter"
                                   role="tab"
                                   aria-controls="nuts-filter"
                                   aria-selected="true">
                                    NUTS
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link"
                                   id="custom-filter-tab"
                                   data-toggle="tab"
                                   href="#custom-filter"
                                   role="tab"
                                   aria-controls="custom-filter"
                                   aria-selected="true">
                                    Custom
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body tab-content" id="filter-card-body">
                        <div class="tab-pane fade show active"
                             id="nuts-filter"
                             role="tabpanel"
                             aria-labelledby="nuts-filter-tab">
                            <form id="nuts-filter-form" method="get">
                                {% crispy nuts_form %}
                            </form>
                        </div>
                        <div class="tab-pane fade"
                             id="custom-filter"
                             role="tabpanel"
                             aria-labelledby="custom-filter-tab">
                            <form id="catchment-filter-form" method="POST">
                                {% csrf_token %}
                                {% crispy form %}
                            </form>
                        </div>
                    </div>
                    {#                    <div class="card-body tab-content" id="custom-filter">#}
                    {#                        <div class="card-title"><strong>Custom Filter</strong></div>#}
                    {#                    </div>#}
                    {#                    <div class="card-body collapse show" id="filter-card-body">#}
                    {#                        <form id="catchment-filter-form" method="POST">#}
                    {#                            {% csrf_token %}#}
                    {#                            {% crispy form %}#}
                    {#                        </form>#}
                    {#                    </div>#}
                </div>
                <div class="card shadow">
                    <div class="card-header"
                         role="button"
                         data-toggle="collapse"
                         href="#info-container"
                         aria-expanded="false"
                         aria-controls="info-container">
                        <b>Catchment information</b>
                    </div>
                    <div class="card-body collapse" id="info-container">
                        <p class="card-text">No data selected, yet.</p>
                    </div>
                </div>

                <!-- Options -->
                <div class="card shadow">
                    <div class="card-header" role="button" data-toggle="collapse" href="#options-card-body"
                         aria-expanded="true" aria-controls="options-card-body">
                        <b>Options</b>
                    </div>
                    <div class="card-body collapse show" id="options-card-body">
                        <a href="{% url 'catchment_definition' %}">
                            <i class="fas fa-fw fa-plus"></i> Create a new catchment
                        </a>
                        <a id="update-link" href="#" style="display: none;">
                            <i class="fas fa-fw fa-edit"></i> Edit this catchment
                        </a>
                        <a data-toggle="modal" id="delete-link" href="#" style="display: none;"
                           data-target="#modal-confirm-delete">
                            <i class="fas fa-fw fa-trash"></i> Delete this catchment
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'modal_confirm_delete.html' %}

{% endblock content %}

{% block javascript %}
    {{ block.super }}
    {{ map_config|json_script:"mapConfig" }}

    <script src="{% static 'js/maps.js' %}"></script>
    <script type="text/javascript">

        const mapConfig = JSON.parse(document.getElementById("mapConfig").textContent);

        async function loadCatchmentOptions() {
            let params = parseFilterParameters()
            let url = "{% url 'ajax_catchment_options' %}" + '?' + $.param(params);
            let response = await fetch(url);
            return await response.text();
        }

        function setCatchmentOptions() {
            loadCatchmentOptions()
                .then(html => document.getElementById("id_catchment").innerHTML = html)
                .catch((err) => console.log(err))
        }

        function updateUrls(catchment_id) {
            let updateLink = document.getElementById("update-link");
            updateLink.href = "{% url 'catchment_update' pk=0 %}".replace("0", catchment_id.toString());
            if (catchment_id === "") {
                updateLink.style.display = "none";
            } else {
                updateLink.style.display = "block";
            }

            form = document.getElementById("delete-confirmation-form")
            form.action = "{% url 'catchment_delete' pk=0%}".replace("0", catchment_id.toString());

            let deleteLink = document.getElementById("delete-link");
            deleteLink.href = "{% url 'catchment_delete' pk=0 %}".replace("0", catchment_id.toString());
            if (catchment_id === "") {
                deleteLink.style.display = "none";
            } else {
                deleteLink.style.display = "block";
            }
        }

        document.getElementById("id_region").onchange = () => {
            setCatchmentOptions();
            fetchRegionGeometry({pk: parseFilterParameters()['region']});
        }
        {#document.getElementById("id_category_1").onchange = () => setCatchmentOptions();#}
        {#document.getElementById("id_category_2").onchange = () => setCatchmentOptions();#}
        document.getElementById("id_catchment").onchange = () => {
            const params = parseFilterParameters();
            fetchFeatureGeometries(params);
            updateUrls(params['catchment']);
        }

        async function selectFeature(feature) {
            let sel = document.getElementById('id_level_' + feature['properties']['nuts_lvl']);
            sel.value = feature['properties']['id'];
            await fetchSelectOptions(sel.dataset['optionsapi'], {id: sel.value});
            await updateLayers(sel.value)
        }

        async function fetchSelectOptions(api_url, params) {
            // fetch options for children of selection
            params['direction'] = 'children'
            let dataurl = api_url + '?' + $.param(params);
            let response = await fetch(dataurl);
            let children = await response.json();
            Object.keys(children).forEach(key => {
                let sel = document.getElementById(key);
                while (sel.firstChild) {
                    sel.removeChild(sel.lastChild);
                }
                let opt = document.createElement('Option');
                opt.value = "";
                opt.innerText = "---------"
                sel.appendChild(opt)
                children[key].forEach(function (item) {
                    opt = document.createElement('Option');
                    opt.value = item.id;
                    opt.innerText = item.name;
                    sel.appendChild(opt);
                });
            });

            // mark the parents of the selected item as also selected
            params['direction'] = 'parents';
            dataurl = api_url + '?' + $.param(params);
            response = await fetch(dataurl)
            let parents = await response.json()
            Object.keys(parents).forEach(key => {
                let sel = document.getElementById(key);
                sel.value = parents[key]['id']
            })
        }

        async function updateLayers(feature_id) {
            // fetch the region geometry
            fetchRegionGeometry({pk: feature_id});

            // fetch the feature geometries
            await fetchFeatureGeometries({'parent_id': feature_id});
            feature_layer.bringToBack();
            feature_layer.off('click');
            feature_layer.on('click', async function (event) {
                await selectFeature(event.layer.feature)
            });
        }

        const changedSelect = async function (e) {
            // fetch options for children of selection
            let params = {id: e.target.value};
            await fetchSelectOptions(e.target.dataset['optionsapi'], params)
            await updateLayers(e.target.value)
        }

        document.querySelectorAll("select").forEach(function (selector) {
            selector.addEventListener("change", changedSelect, false)
        });

        window.onload = () => loadMap(mapConfig);

    </script>

{% endblock %}