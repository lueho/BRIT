"use strict";let isProgrammaticChange=!1;const fieldConfig={nuts_id:{include:!0,format:e=>e||""},name:{include:!0,format:e=>e||""},population:{include:!0,format:e=>e||""},population_density:{include:!0,format:e=>e||""},urban_rural_remoteness:{include:!0,format:e=>e||""}};function lockForm(){document.querySelectorAll("select").forEach((e=>e.disabled=!0))}function unlockForm(){document.querySelectorAll("select").forEach((e=>e.disabled=!1))}async function updateLayers({region_params:e,catchment_params:t,feature_params:a}={}){const n=[e&&fetchRegionGeometry(e),t&&fetchCatchmentGeometry(t),a&&fetchFeatureGeometries(a)].filter(Boolean);prepareMapRefresh(),await refreshMap(n)}function cleanup(){hideLoadingIndicator(),unlockForm(),unlockFilter()}function adaptMapConfig(){mapConfig.layerOrder=["features","region","catchment"]}async function clickedFeature(e){lockForm();const t=e.layer.feature,a=t.properties.id,n=await fetchFeatureDetails(a);renderFeatureDetails(n),setSelect2Value(`#id_level_${t.properties.level}`,a,`${n.name} (${n.nuts_id})`),await updateMapAccordingToSelection()}function getQueryParameters(){const e=new URLSearchParams(window.location.search);if(0===[...e.keys()].length){e.append("levl_code","0");const t=`${window.location.pathname}?${e.toString()}`;window.history.replaceState({},"",t)}return e}function setSelect2Value(e,t,a){const n=document.querySelector(e);if(!n)return;if(n.querySelector(`option[value="${t}"]`))setProgrammaticChange((()=>{n.value=t;const e=new Event("change",{bubbles:!0});n.dispatchEvent(e)}));else{const e=document.createElement("option");e.value=t,e.text=a,e.selected=!0,setProgrammaticChange((()=>{n.appendChild(e);const t=new Event("change",{bubbles:!0});n.dispatchEvent(t)}))}}async function populateParents(e){try{const t=await fetch(`/maps/api/nutsregion/${e}/parents/`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const a=await t.json();for(const[e,t]of Object.entries(a)){const a=e.split("_")[1];t&&setSelect2Value(`#id_level_${a}`,t.id,t.name)}}catch(e){}}function setProgrammaticChange(e){isProgrammaticChange=!0,e(),isProgrammaticChange=!1}async function updateMapAccordingToSelection(){const e=document.getElementById("id_level_0").value,t=document.getElementById("id_level_1").value,a=document.getElementById("id_level_2").value,n=document.getElementById("id_level_3").value,r=n||a||t||e;r?(mapConfig.adjustBoundsToLayer="catchment",setLayerOrder(["region","features","catchment"]),n?await updateLayers({catchment_params:{id:r},feature_params:{id:r}}):await updateLayers({catchment_params:{id:r},feature_params:{parent_id:r}})):(mapConfig.adjustBoundsToLayer="region",setLayerOrder(["features","region"]),await updateLayers({feature_params:{levl_code:0}}))}function clearFields(e){setProgrammaticChange((()=>{e.forEach((function(e){const t=document.getElementById(`id_${e}`);if(t){t.value=null;const e=new Event("change",{bubbles:!0});t.dispatchEvent(e)}}))}))}function resetFeatureDetails(){setLayerOrder(defaultLayerOrder),renderFeatureDetails({})}const changedSelect=async function(e){if(isProgrammaticChange||"SELECT"!==e.target.tagName)return;lockForm();const t=e.target.id;let a=e.target.value;if(a)await populateParents(a),clearLowerFields(t);else{clearLowerFields(t),"id_level_0"===t&&resetFeatureDetails();const e={id_level_1:"id_level_0",id_level_2:"id_level_1",id_level_3:"id_level_2"};e[t]&&(a=document.getElementById(e[t]).value)}if(await updateMapAccordingToSelection(),a){const e=await fetchFeatureDetails(a);await renderFeatureDetails(e)}};function clearLowerFields(e){const t={id_level_0:["level_1","level_2","level_3"],id_level_1:["level_2","level_3"],id_level_2:["level_3"],id_level_3:[]};t[e]&&clearFields(t[e])}document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("form");e&&e.addEventListener("change",(e=>{"SELECT"===e.target.tagName&&changedSelect(e)}))}));