"use strict";let map,regionLayer,catchmentLayer,featuresLayer,regionLayerStyle,catchmentLayerStyle,featuresLayerStyle;const defaultLayerOrder=["region","catchment","features"],clientCacheConfig={maxAge:864e5,maxEntries:500,cacheName:"britMapsCache",cacheVersion:3};function initializeDB(){return new Promise((e,r)=>{const t=indexedDB.open(clientCacheConfig.cacheName,clientCacheConfig.cacheVersion);t.onerror=e=>{console.error("IndexedDB error:",e),r("IndexedDB error")},t.onupgradeneeded=e=>{const r=e.target.result;if(!r.objectStoreNames.contains("geojson")){r.createObjectStore("geojson",{keyPath:"url"}).createIndex("timestamp","timestamp")}},t.onsuccess=r=>{e(r.target.result)}})}async function storeInIndexedDB(e,r,t=null){try{const a=await initializeDB();return new Promise((n,o)=>{const i=a.transaction(["geojson"],"readwrite").objectStore("geojson"),c={url:e,data:r,timestamp:Date.now(),version:t},s=i.put(c);s.onsuccess=()=>n(),s.onerror=e=>{console.error("Error storing in IndexedDB:",e),o(e)}})}catch(e){console.warn("Error accessing IndexedDB:",e)}}async function getFromIndexedDB(e){try{const r=await initializeDB();return new Promise((t,a)=>{const n=r.transaction(["geojson"],"readonly").objectStore("geojson").get(e);n.onsuccess=r=>{const a=r.target.result;a&&Date.now()-a.timestamp<clientCacheConfig.maxAge?(console.log(`Cache hit for: ${e}`),t(a)):(console.log(`Cache miss for: ${e}`),t(null))},n.onerror=e=>{console.error("Error retrieving from IndexedDB:",e),a(e)}})}catch(e){return console.warn("Error accessing IndexedDB:",e),null}}async function fetchDataVersion(e){try{const r=e.replace("/geojson/","/version/"),t=await fetch(r,{method:"GET"});if(!t.ok)return console.warn(`Version check failed: ${t.status}`),null;return(await t.json()).version||t.headers.get("X-Data-Version")}catch(e){return console.warn("Error fetching data version:",e),null}}async function fetchWithVersionValidation(e,r){const t=await getFromIndexedDB(r);if(t&&t.version){const a=await fetchDataVersion(e);if(a&&a===t.version)return console.log(`Version validated, using cached data for: ${r}`),{data:t.data,fromCache:!0};console.log(`Version mismatch (cached: ${t.version}, current: ${a}), fetching fresh data`)}else if(t)return console.log(`Using legacy cached data for: ${r}`),{data:t.data,fromCache:!0};const a=await fetch(e);if(!a.ok)throw new Error(`HTTP error ${a.status}: ${a.statusText}`);const n=await a.json(),o=a.headers.get("X-Data-Version");return await storeInIndexedDB(r,n,o),await cleanupCache(),{data:n,fromCache:!1}}function normalizeUrl(e){try{const r=new URL(e);r.searchParams.delete("csrfmiddlewaretoken");for(const[e,t]of Array.from(r.searchParams.entries()))""===t.trim()&&r.searchParams.delete(e);return r.searchParams.sort(),r.toString()}catch(r){return console.error("Error normalizing URL:",r),e}}async function cleanupCache(){try{const e=await initializeDB(),r=e.transaction(["geojson"],"readwrite").objectStore("geojson"),t=r.index("timestamp").openCursor(null,"prev");let a=0;const n=[];t.onsuccess=e=>{const t=e.target.result;t?(a++,a>clientCacheConfig.maxEntries&&n.push(t.primaryKey),t.continue()):(n.forEach(e=>r.delete(e)),n.length>0&&console.log(`Cleaned up ${n.length} old cache entries.`))},t.onerror=e=>{console.error("Error cleaning up cache:",e)}}catch(e){console.warn("Error accessing IndexedDB for cache cleanup:",e)}}function showLoadingIndicator(){map.spin(!0)}function hideLoadingIndicator(){map.spin(!1)}function showMapOverlay(){try{document.getElementById("map-overlay").style.display="flex"}catch(e){console.warn("Map overlay could not be shown:",e)}}function hideMapOverlay(){try{document.getElementById("map-overlay").style.display="none"}catch(e){console.warn("Map overlay could not be hidden:",e)}}function displayErrorMessage(e){console.error(`An error occurred while fetching data: ${e}`)}function displayTimeoutError(){console.error("The request has timed out. Please try reducing the size of the dataset by setting more specific filter parameters.")}function prepareMapRefresh(){try{lockCustomElements()}catch(e){console.warn("Custom elements were not locked",e)}try{lockFilter()}catch(e){console.warn("Filter was not locked",e)}showLoadingIndicator()}function clearMap(){map.eachLayer(e=>{e instanceof L.GeoJSON&&map.removeLayer(e)})}function refreshMap(e,r=12e4){let t=!0;Promise.all(e).then(()=>{t=!1,orderLayers(),adjustMapBounds()}).catch(e=>{t=!1,displayErrorMessage(e)}).finally(cleanup),setTimeout(()=>{t&&(t=!1,displayTimeoutError(),cleanup())},r)}function updateUrlSearchParams(){const e=parseFilterParameters(),r=new URL(window.location);r.search=e.toString(),window.history.replaceState({},"",r.toString())}function cleanup(){try{updateUrlSearchParams()}catch(e){console.warn("URL search parameters were not updated:",e)}hideLoadingIndicator();try{unlockFilter()}catch(e){console.warn("Filter was not unlocked",e)}try{unlockCustomElements()}catch(e){console.warn("Custom elements were not unlocked",e)}}function orderLayers(e=mapConfig.layerOrder||defaultLayerOrder){if(!Array.isArray(e))return void console.error("Invalid layerOrder. Expected an array.");const r=["region","catchment","features"],t=e.filter(e=>!r.includes(e));t.length>0&&console.warn(`Unknown layer keys found: ${t.join(", ")}`);e.filter(e=>r.includes(e)).forEach((e,r)=>{"region"===e?regionLayer?.bringToFront():"catchment"===e?catchmentLayer?.bringToFront():"features"===e&&featuresLayer?.bringToFront()})}function setLayerOrder(e){if(!Array.isArray(e)||0===e.length)return console.warn("Invalid or empty layerOrder. Resetting to default."),void(mapConfig.layerOrder=defaultLayerOrder);const r=["region","catchment","features"],t=e.filter(e=>r.includes(e));if(0===t.length)return console.warn("No valid keys in layerOrder. Resetting to default."),void(mapConfig.layerOrder=defaultLayerOrder);mapConfig.layerOrder=t}function getQueryParameters(){return console.info("getQueryParameters() is not overwritten. Using default implementation."),parseFilterParameters()}function transformSearchParams(e){if(e instanceof URLSearchParams)return e;{const r=new URLSearchParams;for(const[t,a]of Object.entries(e))Array.isArray(a)?a.forEach(e=>r.append(t,e)):r.append(t,a.toString());return r}}async function fetchData(e){try{const r=await fetch(e);if(!r.ok)throw new Error(`HTTP error ${r.status}: ${r.statusText}`);return await r.json()}catch(r){throw console.error(`Error fetching data from ${e}:`,r),r}}function validateParams(e,r){for(const t of r)if(!e||!(t in e))throw new Error(`Missing required parameter: ${t}`)}function buildUrl(e,r){const t=new URL(e,window.location.origin);return t.search=transformSearchParams(r).toString(),t.toString()}async function fetchRegionGeometry(e){validateParams(e,["id"]);const r=buildUrl(mapConfig.regionLayerGeometriesUrl,{id:e.id}),t=normalizeUrl(r);try{const{data:e}=await fetchWithVersionValidation(r,t);renderRegion(e)}catch(e){console.error("Error fetching region geometry:",e),displayErrorMessage(e)}}async function fetchCatchmentGeometry(e){validateParams(e,["id"]);const r=buildUrl(mapConfig.catchmentLayerGeometriesUrl,{id:e.id}),t=normalizeUrl(r);try{const{data:e}=await fetchWithVersionValidation(r,t);renderCatchment(e)}catch(e){console.error("Error fetching catchment geometry:",e),displayErrorMessage(e)}}async function fetchFeatureGeometries(e){hideMapOverlay();const r=mapConfig.featuresId?{id:mapConfig.featuresId}:e,t=buildUrl(mapConfig.featuresLayerGeometriesUrl,r),a=normalizeUrl(t);console.log("Fetching features for URL:",t,"with finalParams:",r),console.log("Normalized cache key:",a);try{const{data:e,fromCache:r}=await fetchWithVersionValidation(t,a);console.log(`Features ${r?"loaded from cache":"fetched from network"}:`,e),renderFeatures(e)}catch(e){console.error("Error fetching feature geometries:",e),displayErrorMessage(e)}}async function fetchFeatureDetails(e){let r="object"==typeof e?e.id||e.properties.id:e;if(r=r.toString(),Number.isInteger(parseInt(r))){const e=`${mapConfig.featuresLayerDetailsUrlTemplate}${r}/`,t=await fetch(e);return await t.json()}console.warn("The provided feature id is not a valid integer number:",r)}async function fetchFeaturesLayerSummary(e){const r=mapConfig.featuresLayerSummariesUrl+"?"+transformSearchParams(e).toString();try{const e=await fetch(r);if(!e.ok)throw new Error(`HTTP error ${e.status}: ${e.statusText}`);renderSummaries(await e.json())}catch(e){console.error("Error fetching layer summary:",e)}}function removeExistingLayer(e){e&&map.removeLayer(e)}function initializeRenderers(){const e=L.canvas({padding:.5});regionLayerStyle=mapConfig.regionLayerStyle,regionLayerStyle.renderer=e,catchmentLayerStyle=mapConfig.catchmentLayerStyle,catchmentLayerStyle.renderer=e,featuresLayerStyle=mapConfig.featuresLayerStyle,featuresLayerStyle.renderer=e}function renderRegion(e){removeExistingLayer(regionLayer),regionLayer=L.geoJson(e,{style:regionLayerStyle,interactive:!1,pane:"regionPane"}),regionLayer.addTo(map)}function renderCatchment(e){removeExistingLayer(catchmentLayer),catchmentLayer=L.geoJson(e,{style:catchmentLayerStyle,interactive:!1,pane:"catchmentPane"}),catchmentLayer.addTo(map)}function createFeatureLayerBindings(e){e.on("click",async function(e){await clickedFeature(e)})}function renderFeatures(e){if(!e||!e.features||0===e.features.length)return void console.warn("The provided GeoJSON object is empty or does not contain any features.");removeExistingLayer(featuresLayer);const r=e.features[0].geometry.type;"Polygon"===r||"MultiPolygon"===r?featuresLayer=L.geoJson(e,{style:featuresLayerStyle,pane:"featuresPane"}):"Point"===r&&(featuresLayer=L.geoJson(e,{pointToLayer:(e,r)=>L.circleMarker(r,featuresLayerStyle),pane:"featuresPane"})),createFeatureLayerBindings(featuresLayer),featuresLayer.addTo(map)}function adjustMapBounds(){const e=[{key:"region",layer:regionLayer},{key:"catchment",layer:catchmentLayer},{key:"features",layer:featuresLayer}],r=e.findIndex(e=>e.key===mapConfig.adjustBoundsToLayer);if(-1===r)return console.warn(`Invalid preferred layer: ${mapConfig.adjustBoundsToLayer}`),!1;const t=[...e.slice(r),...e.slice(0,r)];for(const{key:e,layer:r}of t)if(r&&r.getBounds)try{const e=r.getBounds();if(e.isValid())return map.fitBounds(e),!0}catch(r){console.warn(`Failed to adjust bounds to ${e} layer:`,r)}return console.warn("No valid layers found for bounds adjustment"),!1}function isEmptyArray(e){return Array.isArray(e)&&0===e.length}function isValidHttpUrl(e){let r;try{r=new URL(e)}catch(e){return!1}return"http:"===r.protocol||"https:"===r.protocol}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function renderSummaryContainer(e,r){Object.keys(e).forEach(t=>{if(!isEmptyArray(e[t])&&null!==e[t]){const a=document.createElement("div"),n=document.createElement("P"),o=document.createElement("B");o.innerText=t.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase());let i=e[t];"object"==typeof e[t]&&("label"in e[t]&&(o.innerText=e[t].label.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())),"value"in e[t]&&(i=e[t].value)),o.innerText+=":",n.appendChild(o),a.appendChild(n);const c=document.createElement("P");if(Array.isArray(i)){const e=document.createElement("ul");c.appendChild(e),i.forEach(function(r){const t=document.createElement("li");if(r&&"object"==typeof r&&"url"in r&&"name"in r){const e=document.createElement("a");e.href=r.url,e.innerText=r.name,e.setAttribute("target","_blank"),t.appendChild(e)}else if(isValidHttpUrl(r.toString())){const e=document.createElement("a");e.href=r.toString(),e.innerText=r.toString(),e.setAttribute("target","_blank"),t.appendChild(e)}else t.innerText=r.toString();e.appendChild(t)})}else c.innerText=i.toString();a.appendChild(c),"id"===t&&(a.className="d-none",r.className+=" pk-holder",r.setAttribute("data-pk",e.id)),r.appendChild(a)}})}function renderSummaries(e){const r=document.getElementById("summary-container");if(r.textContent="","summaries"in e){if(e.summaries.length>1){const t=document.createElement("P");t.innerText="Found "+e.summaries.length+" items:",r.appendChild(t);const a=document.createElement("div");a.id="summaries_accordion",a.className="accordion",r.appendChild(a),e.summaries.forEach((e,r)=>{const t=document.createElement("div");t.className="card",a.appendChild(t);const n=document.createElement("div");n.className="card-header collapse-selector",n.setAttribute("role","button"),n.setAttribute("data-toggle","collapse"),n.setAttribute("href","#collapse"+r.toString()),n.setAttribute("aria-expanded","true"),n.setAttribute("aria-controls","collapse"+r.toString()),e.id&&n.setAttribute("data-pk",e.id);const o=r+1;n.innerHTML="<b>#"+o.toString()+"</b>",t.appendChild(n);const i=document.createElement("div");i.id="collapse"+r.toString(),i.className="summary collapse",i.setAttribute("aria-labelledby","collapse"+r.toString()),i.setAttribute("data-parent","#summaries_accordion"),t.appendChild(i);const c=document.createElement("div");c.className="card-body",i.appendChild(c),renderSummaryContainer(e,c)})}else if(1===e.summaries.length){renderSummaryContainer(e.summaries[0],r)}document.querySelector("#info-card-body").classList.add("show")}}async function getFeatureDetails(e){try{renderFeatureDetails(await fetchFeatureDetails(e)),scrollToSummaries(),updateUrls(e)}catch(r){console.error(`Error fetching feature details for id ${e}: ${r}`)}}function formatHeader(e){return e.replace(/([A-Z])/g," $1").replace(/_/g," ").replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()).trim()}function formatList(e,r){if(!e)return"";const t=e.split(r).filter(e=>e.trim());return 0===t.length?"":`<ul class="list-disc pl-4">\n        ${t.map(e=>`<li>${e.trim()}</li>`).join("")}\n    </ul>`}function truncateUrl(e,r=40){return e.length>r?e.substring(0,r)+"...":e}function formatUrls(e){if(!e)return"";const r=e.split(", ").filter(Boolean);return 0===r.length?"":r.map(e=>`<li>\n            <a href="${e}" \n               title="${e}"\n               target="_blank" \n               rel="noopener noreferrer"\n               class="url-link hover:text-blue-600">\n                ${truncateUrl(e)}\n            </a>\n        </li>`).join("")}function renderFeatureDetails(e){const r=document.getElementById("summary-container");r.innerHTML="";const t=document.createDocumentFragment();Object.entries(e).filter(([e])=>fieldConfig[e]?.include).forEach(([e,r])=>{const a=fieldConfig[e].format(r);if(a){const r=formatHeader(e),n=document.createElement("p"),o=document.createElement("strong");o.textContent=`${r}:`,n.appendChild(o),n.appendChild(document.createElement("br")),n.innerHTML+=a,t.appendChild(n)}}),r.appendChild(t),document.querySelector("#info-card-body").classList.add("show")}function scrollToSummaries(){}function updateUrls(e){}async function clickedFeature(e){}function clickedFilterButton(){let e;prepareMapRefresh();try{e=parseFilterParameters()}catch(e){console.warn("Filter parameters could not be parsed:",e)}mapConfig.loadFeatures=!0,loadLayers(e)}function adaptMapConfig(){}function loadMap(e){if(e){adaptMapConfig(),initializeRenderers(),prepareMapRefresh();try{loadLayers()}catch(e){console.error("Failed to load layers:",e)}}else console.error("mapConfig is not defined or invalid.")}function getFeaturesLayerFilterParameters(){let e;try{return e=mapConfig.applyFilterToFeatures?parseFilterParameters():getQueryParameters(),e||(console.warn("Parameters are undefined. Using default configuration."),new URLSearchParams)}catch(e){return console.warn("Filter parameters could not be parsed:",e),new URLSearchParams}}function lockCustomElements(){try{const e=document.querySelector("form");if(!e)return;e.querySelectorAll("input, select, textarea, button").forEach(e=>{e.classList.contains("submit-filter")||(e.dataset.prevDisabled=e.disabled?"1":"0",e.disabled=!0)})}catch(e){console.warn("Failed to lock custom elements:",e)}}function unlockCustomElements(){try{const e=document.querySelector("form");if(!e)return;e.querySelectorAll("input, select, textarea, button").forEach(e=>{e.classList.contains("submit-filter")||("0"===e.dataset.prevDisabled&&(e.disabled=!1),delete e.dataset.prevDisabled)})}catch(e){console.warn("Failed to unlock custom elements:",e)}}function loadLayers(){const e=getFeaturesLayerFilterParameters(),r=[],t=e.get("region")||(mapConfig.loadRegion?mapConfig.regionId:null);t?r.push(fetchRegionGeometry({id:t})):(removeExistingLayer(regionLayer),regionLayer=null);const a=e.get("catchment")||(mapConfig.loadCatchment?mapConfig.catchmentId:null);if(a?r.push(fetchCatchmentGeometry({id:a})):(removeExistingLayer(catchmentLayer),catchmentLayer=null),!0===mapConfig.loadFeatures)r.push(fetchFeatureGeometries(e)),r.push(fetchFeaturesLayerSummary(e));else try{showMapOverlay()}catch(e){console.warn("Map overlay could not be shown:",e)}r.length>0?Promise.all(r).then(()=>refreshMap(r)).catch(e=>console.error("Error loading layers or refreshing map:",e)):console.warn("No layers to load.")}function selectFeature(e){e.bringToFront(),e.setStyle({color:"#f49a33"})}function resetFeatureStyles(e){e.resetStyle(),e.bringToBack()}window.addEventListener("map:init",function(e){map=e.detail.map});