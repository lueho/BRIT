{% extends "base.html" %}
{% load i18n %}
{% load moderation_tags %}

{% block title %}BRIT | {{ object.name }} details{% endblock %}

{% block content %}
{# Optional rejection alert shown above the card #}
{% if object.is_declined and request.user == object.owner and not review_mode %}
<div class="row mt-4">
  <div class="col">
    <div class="card border-danger shadow-sm">
      <div class="card-header bg-danger text-white">
        <strong><i class="fas fa-circle-xmark"></i> {% trans "Submission Rejected" %}</strong>
      </div>
      <div class="card-body">
        {% with last_rej=object.get_last_rejection_action %}
          {% if last_rej %}
            <p class="mb-2"><strong>{% trans "Moderator" %}:</strong> {{ last_rej.user }}</p>
            <p class="mb-2"><strong>{% trans "Date" %}:</strong> {{ last_rej.created_at|date:"Y-m-d H:i" }}</p>
            <p class="mb-0"><strong>{% trans "Comments" %}:</strong><br>
              {% if last_rej.comment %}
                {{ last_rej.comment|linebreaksbr }}
              {% else %}
                <span class="text-muted">{% trans "No comments provided." %}</span>
              {% endif %}
            </p>
            <hr class="my-3" />
            <form method="post" action="{% url 'object_management:submit_for_review' content_type_id=object|get_content_type_id object_id=object.id %}?next={{ object.get_absolute_url }}">
              {% csrf_token %}
              <div class="mb-2">
                <label for="resubmit-comment" class="form-label"><strong>{% trans "Your explanation (optional)" %}</strong></label>
                <textarea id="resubmit-comment" name="comment" rows="3" class="form-control" placeholder="{% trans "Explain what you changed to address the feedback." %}"></textarea>
              </div>
              <button type="submit" class="btn btn-danger">
                <i class="fas fa-paper-plane"></i> {% trans "Resubmit for review" %}
              </button>
            </form>
          {% else %}
            <p class="mb-0">{% trans "This submission was rejected. No additional details are available." %}</p>
          {% endif %}
        {% endwith %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row my-4">
  <div class="col-lg-8">
    <div class="card shadow">
      <div class="card-header d-flex justify-content-between align-items-center bg-body-tertiary border-bottom-0 py-3">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <h5 class="mb-0">
            {% block detail_header %}{{ object.verbose_name|capfirst }} {% trans "details" %}{% endblock %}
          </h5>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          {% block detail_header_badge %}{% endblock detail_header_badge %}
          {% block detail_header_actions %}{% endblock detail_header_actions %}
        </div>
      </div>

      {% block detail_top_image %}{% endblock detail_top_image %}

      <div class="card-body">
        {% if show_review_panel %}
          {% include "object_management/review_panel.html" with object=object %}
        {% endif %}
        {% block detail_body %}
        <p class="card-text"><strong>{% trans "Name" %}:</strong><br>{{ object.name }}</p>
        {% if object.description %}
        <p class="card-text"><strong>{% trans "Description" %}:</strong><br>{{ object.description }}</p>
        {% endif %}
        {% endblock detail_body %}
      </div>

      <div class="card-footer d-flex">
        {% block detail_card_footer %}
          {% block detail_footer_left %}{% endblock detail_footer_left %}
          {% block detail_footer_right %}{% endblock detail_footer_right %}
        {% endblock detail_card_footer %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow filter-sticky">
      <div class="card-header p-0 border-0 bg-body-tertiary">
        <ul class="nav nav-pills sidebar-tabs px-3 pt-3 pb-2" id="detailSidebarTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="options-tab" data-bs-toggle="tab" data-bs-target="#options-pane" type="button" role="tab" aria-controls="options-pane" aria-selected="true">
              <i class="fas fa-gear"></i> {% block options_tab_title %}{% trans "Options" %}{% endblock options_tab_title %}
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="learning-tab" data-bs-toggle="tab" data-bs-target="#learning-pane" type="button" role="tab" aria-controls="learning-pane" aria-selected="false">
              <i class="fas fa-graduation-cap"></i> {% block learning_tab_title %}{% trans "Learning" %}{% endblock learning_tab_title %}
            </button>
          </li>
          {% block extra_tabs %}{% endblock extra_tabs %}
        </ul>
      </div>
      <div class="card-body">
        <div class="tab-content">
          <div class="tab-pane fade show active" id="options-pane" role="tabpanel" aria-labelledby="options-tab" tabindex="0">
            {% block options_pane %}
              {% block options_primary_actions %}{% endblock options_primary_actions %}
              {% block options_secondary_actions %}{% endblock options_secondary_actions %}
              {% block options_review_actions %}{% endblock options_review_actions %}
              {% block options_export %}{% endblock options_export %}
              {% block options_custom_panels %}{% endblock options_custom_panels %}
            {% endblock options_pane %}
          </div>
          <div class="tab-pane fade" id="learning-pane" role="tabpanel" aria-labelledby="learning-tab" tabindex="0">
            {% block learning_content %}{% endblock learning_content %}
          </div>
          {% block extra_tab_panes %}{% endblock extra_tab_panes %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  {% block second_row %}{% endblock second_row %}
  {# Optional extra row for child templates, mirroring simple_detail_card.html #}
</div>
{% endblock content %}

{% block javascript %}
  {{ block.super }}
  {% block detail_with_options_scripts %}{% endblock detail_with_options_scripts %}
{% endblock javascript %}
