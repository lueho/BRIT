{% extends "base.html" %}

{% block content %}
    {% load crispy_forms_tags %}

    <h2 class="test">Add an algorithm to the scenario "{{ scenario.name }}"</h2>
    <form method="post" id="configForm">
        {% csrf_token %}
        {{ form|crispy }}
        <div id="parameterFormContainer" class="form-group"></div>
        <button type="submit" class="btn btn-primary">Save</button>
        <a href="{{ view.get_success_url }}" class="btn btn-secondary">Cancel</a>
    </form>

{% endblock content %}

{% block javascript %}
    {{ block.super }}
    {{ parameters|json_script:"data" }}

    <script type="text/javascript">
        const form = document.getElementById("configForm");
        const initialParameters = JSON.parse(document.getElementById("data").textContent);

        function renderParameterFields(parameters, preselectedValues = null) {
            if (!parameters || parameters.length === 0) {
                document.getElementById("parameterFormContainer").innerHTML = "";
                return;
            }

            let html = "<h3>Parameters for this algorithm:</h3>";
            for (const param of parameters) {
                const preselected = preselectedValues ? preselectedValues[param.short_name] : null;
                html += `
                    <div id="div_id_parameter_${param.id}" class="form-group">
                        <label class="requiredField" for="id_parameter_${param.id}">${param.descriptive_name}</label>
                        <div>
                            <select id="id_parameter_${param.id}" class="select form-control" name="parameter_${param.id}">
                                <option value="">---------</option>
                                ${param.values.map(v => {
                                    const isSelected = preselected ? v.id == preselected : v.default;
                                    return `<option value="${v.id}"${isSelected ? ' selected' : ''}>${v.name || v.value}</option>`;
                                }).join('')}
                            </select>
                        </div>
                    </div>
                `;
            }
            document.getElementById("parameterFormContainer").innerHTML = html;
        }

        async function loadInventoryAlgorithmParameters(preselectedValues = null) {
            const algorithmId = form.inventory_algorithm.value;
            if (!algorithmId) {
                document.getElementById("parameterFormContainer").innerHTML = "";
                return;
            }

            const url = `/inventories/api/inventory-algorithms/${algorithmId}/parameters/`;
            try {
                const response = await fetch(url);
                if (response.ok) {
                    const parameters = await response.json();
                    renderParameterFields(parameters, preselectedValues);
                }
            } catch (err) {
                console.error("Error loading parameters:", err);
            }
        }

        function buildPreselectedMap() {
            const map = {};
            for (const param of initialParameters) {
                const name = Object.keys(param)[0];
                map[name] = param[name];
            }
            return map;
        }

        document.addEventListener("DOMContentLoaded", function() {
            loadInventoryAlgorithmParameters(buildPreselectedMap());
        });

        const algorithmField = document.getElementById("id_inventory_algorithm");
        if (algorithmField) {
            algorithmField.addEventListener("change", () => loadInventoryAlgorithmParameters());
        }
    </script>

{% endblock javascript %}
