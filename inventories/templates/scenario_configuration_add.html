{% extends "simple_form_card.html" %}

{% block extra_post_form_content %}
    <div id="parameterFormContainer" class="form-group"></div>
{% endblock extra_post_form_content %}

{% block cancel_button %}
    <a href="{{ view.get_success_url }}" class="btn btn-secondary">Cancel</a>
{% endblock cancel_button %}

{% block javascript %}
    {{ block.super }}

    <script>
        const form = document.getElementById("configForm");

        function renderParameterFields(parameters) {
            if (!parameters || parameters.length === 0) {
                document.getElementById("parameterFormContainer").innerHTML = "";
                return;
            }

            let html = "<h3>Parameters for this algorithm:</h3>";
            for (const param of parameters) {
                html += `
                    <div id="div_id_parameter_${param.id}" class="form-group">
                        <label class="requiredField" for="id_parameter_${param.id}">${param.descriptive_name}</label>
                        <div>
                            <select id="id_parameter_${param.id}" class="select form-control" name="parameter_${param.id}">
                                <option value="">---------</option>
                                ${param.values.map(v => `<option value="${v.id}"${v.default ? ' selected' : ''}>${v.name || v.value}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                `;
            }
            document.getElementById("parameterFormContainer").innerHTML = html;
        }

        async function loadInventoryAlgorithmParameters() {
            const algorithmId = form.inventory_algorithm.value;
            if (!algorithmId) {
                document.getElementById("parameterFormContainer").innerHTML = "";
                return;
            }

            const url = `/inventories/api/inventory-algorithms/${algorithmId}/parameters/`;
            try {
                const response = await fetch(url);
                if (response.ok) {
                    const parameters = await response.json();
                    renderParameterFields(parameters);
                }
            } catch (err) {
                console.error("Error loading parameters:", err);
            }
        }

        const algorithmField = document.getElementById("id_inventory_algorithm");
        if (algorithmField) {
            algorithmField.addEventListener("change", loadInventoryAlgorithmParameters);
        }
    </script>

{% endblock javascript %}
